var hashLoc,hashSet=function(a){if(a||a.p){hashLoc=a.p;var b=!0;switch(a.p){case "client":"info"==a.d&&(hashLoc+="_"+a.id);break;case "zayav":"info"==a.d?hashLoc+="_"+a.id:"add"==a.d?hashLoc+="_add"+(REGEXP_NUMERIC.test(a.id)?"_"+a.id:""):a.d||(b=!1);break;default:a.d&&(hashLoc+="_"+a.d,a.d1&&(hashLoc+="_"+a.d1))}b&&VK.callMethod("setLocation",hashLoc)}},pinEnter=function(){var a={op:"pin_enter",pin:$.trim($("#pin").val())};a.pin&&2<a.pin.length&&($(".vkButton").addClass("busy"),$.post(AJAX_MAIN,
a,function(a){a.success?document.location.href=URL:($(".vkButton").removeClass("busy"),$("#pin").val(""),$(".red").html(a.text))},"json"))},clientAdd=function(a){function b(){var b={op:"client_add",fio:$("#fio").val(),telefon:$("#telefon").val(),adres:$("#adres").val(),pasp_seria:$("#pasp_seria").val(),pasp_nomer:$("#pasp_nomer").val(),pasp_adres:$("#pasp_adres").val(),pasp_ovd:$("#pasp_ovd").val(),pasp_data:$("#pasp_data").val()};b.fio?(dialog.process(),$.post(AJAX_MAIN,b,function(b){b.success?(dialog.close(),
_msg("Новый клиент внесён."),"function"==typeof a?a(b):document.location.href=URL+"&p=client&d=info&id="+b.uid):dialog.abort()},"json")):(dialog.bottom.vkHint({msg:'<SPAN class="red">Не указано имя клиента.</SPAN>',top:-47,left:103,indent:40,show:1,remove:1}),$("#fio").focus())}dialog=_dialog({top:60,width:380,head:"Добавление нoвого клиента",content:'<table class="client-add"><tr><td class="label">Имя:<td><input type="text" id="fio" maxlength="100"><tr><td class="label">Телефон:<td><input type="text" id="telefon" maxlength="100"><tr><td class="label">Адрес:<td><input type="text" id="adres" maxlength="100"><tr class="tr_pasp"><td colspan="2"><a>Заполнить паспортные данные</a><tr class="dn"><td><td><b>Паспортные данные:</b><tr class="dn"><td class="label">Серия:<td><input type="text" id="pasp_seria" maxlength="8"><span class="label">Номер:</span><input type="text" id="pasp_nomer" maxlength="10"><tr class="dn"><td class="label">Прописка:<td><input type="text" id="pasp_adres" maxlength="100"><tr class="dn"><td class="label">Кем выдан:<td><input type="text" id="pasp_ovd" maxlength="100"><tr class="dn"><td class="label">Когда выдан:<td><input type="text" id="pasp_data" maxlength="100"></table>',
submit:b});$("#fio").focus();$("#fio,#telefon,#adres").keyEnter(b);$(".tr_pasp a").click(function(){$(".tr_pasp").remove();$(".client-add .dn").removeClass("dn");$("#pasp_seria").focus()})},clientFilter=function(){var a={op:"client_spisok",fast:cFind.inp(),dolg:$("#dolg").val(),note:$("#note").val(),product_id:$("#product_id").val()};$(".filter")[a.fast?"hide":"show"]();return a},clientSpisok=function(){var a=clientFilter(),b=$(".result");b.hasClass("busy")||(b.addClass("busy"),$.post(AJAX_MAIN,a,
function(a){b.removeClass("busy");a.success&&(b.html(a.result),$(".left").html(a.spisok))},"json"))},clientZayavFilter=function(){return{client:CLIENT.id,status:$("#status").val()}},clientZayavSpisokLoad=function(){var a=clientZayavFilter();a.op="client_zayav_load";$("#dopLinks").addClass("busy");$.post(AJAX_MAIN,a,function(a){$("#dopLinks").removeClass("busy");$("#zayav_result").html(a.all);$("#zayav_spisok").html(a.html)},"json")},zayavZamerDtime=function(a){a=$.extend({day:"",hour:10,min:0},a);
a='<table><tr><td><INPUT TYPE="hidden" id="zamer_day" value="'+a.day+'" /><td><INPUT TYPE="hidden" id="zamer_hour" value="'+a.hour+'" /><td> : <td><INPUT TYPE="hidden" id="zamer_min" value="'+a.min+'" /></table>';$(".zayav-zamer-dtime").html(a);$("#zamer_day")._calendar();$("#zamer_hour")._select({width:40,spisok:ZAMER_HOUR});$("#zamer_min")._select({width:40,spisok:ZAMER_MIN});$("#zamer_duration")._select({width:100,spisok:ZAMER_DURATION})},zayavFindFast=function(){var a={op:"zayav_findfast",find:$.trim($("#find input").val())};
$(".find-hide")[(a.find?"add":"remove")+"Class"]("dn");a.find?($("#mainLinks").addClass("busy"),$.post(AJAX_MAIN,a,function(a){$("#mainLinks").removeClass("busy");a.success&&($("#zayav .result").html(a.result),$("#zayav #spisok").html(a.spisok))},"json")):zayavSpisok()},zayavFilter=function(){return{category:$("#zayav").attr("val"),product:$("#product_id").val(),status:$("#status").val()}},zayavSpisok=function(){var a=zayavFilter();a.op="zayav_spisok";$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,
a,function(a){$("#mainLinks").removeClass("busy");a.success&&($("#zayav .result").html(a.result),$("#zayav #spisok").html(a.spisok))},"json")},dogovorCreate=function(a){function b(b){var d={id:DOG.id,zayav_id:ZAYAV.id,fio:$("#fio").val(),adres:$("#adres").val(),pasp_seria:$("#pasp_seria").val(),pasp_nomer:$("#pasp_nomer").val(),pasp_adres:$("#pasp_adres").val(),pasp_ovd:$("#pasp_ovd").val(),pasp_data:$("#pasp_data").val(),nomer:$("#nomer").val(),data_create:$("#data_create").val(),sum:$("#sum").val(),
avans:$("#avans").val(),reason:"reneg"==a?$("#reason").val():""};if(d.fio)if(REGEXP_NUMERIC.test(d.nomer)&&0!=d.nomer)if(REGEXP_CENA.test(d.sum)&&0!=d.sum)if(d.avans&&!REGEXP_CENA.test(d.avans))c("Некорректно указан авансовый платёж","avans",b);else{if("reneg"!=a||d.reason)return d;c("Не указана причина перезаключения договора","reason",b)}else c("Некорректно указана сумма по договору","sum",b);else c("Некорректно указан номер договора","nomer",b);else c("Не указано Фио клиента","fio",b);return!1}
function c(a,d,b){e.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:b?-86:-47,left:b?173:142,indent:50,show:1,remove:1});d&&$("#"+d).focus()}var d="Заключение",g="Заключить договор";switch(a){default:a="create";case "create":break;case "edit":d="Изменение данных";g="Применить";break;case "reneg":d="Перезаключение",g="Перезаключить договор"}var e=_dialog({width:480,top:10,head:d+" договора",content:'<table class="zayav-dogovor"><tr><td class="label">Фио клиента:<td><input type="text" id="fio" value="'+
DOG.fio+'" /><tr><td class="label">Адрес:<td><input type="text" id="adres" value="'+DOG.adres+'" /><tr><td class="label">Паспорт:<td>Серия:<input type="text" id="pasp_seria" maxlength="8" value="'+DOG.pasp_seria+'" />Номер:<input type="text" id="pasp_nomer" maxlength="10" value="'+DOG.pasp_nomer+'" /><tr><td><td><span class="l">Прописка:</span><input type="text" id="pasp_adres" maxlength="100" value="'+DOG.pasp_adres+'" /><tr><td><td><span class="l">Кем выдан:</span><input type="text" id="pasp_ovd" maxlength="100" value="'+
DOG.pasp_ovd+'" /><tr><td><td><span class="l">Когда выдан:</span><input type="text" id="pasp_data" maxlength="100" value="'+DOG.pasp_data+'" /><tr><td class="label">Номер договора:<td><input type="text" id="nomer" maxlength="6" value="'+DOG.nomer+'" /><tr><td class="label">Дата заключения:<td><input type="hidden" id="data_create" value="'+(DOG.data_create?DOG.data_create:"")+'" /><tr><td class="label">Сумма по договору:<td><input type="text" id="sum" class="money" maxlength="11" value="'+(DOG.sum?
DOG.sum:"")+'" /> руб.<tr><td class="label">Авансовый платёж:<td><input type="text" id="avans" class="money" maxlength="11" value="'+(DOG.avans?DOG.avans:"")+'" /> руб. <span class="prim">(не обязательно)</span>'+("reneg"==a?'<tr><td class="label">Причина перезаключения:<td><input type="text" id="reason" />':"")+'<tr><td colspan="2"><a id="preview">Предварительный просмотр</a><form action="'+AJAX_MAIN+'" method="post" id="preview-form" target="_blank"></form></table>',butSubmit:g,submit:function(){var d=
b();d&&(d.op="dogovor_"+a,e.process(),$.post(AJAX_MAIN,d,function(a){a.success?(e.close(),_msg("Договор заключен."),document.location.reload()):(e.abort(),c(a.text))},"json"))}});$("#data_create")._calendar({lost:1});$("#preview").click(function(){var a=b("preview");if(a){a.op="dogovor_preview";var d="",c;for(c in a)d+='<input type="hidden" name="'+c+'" value="'+a[c]+'">';$("#preview-form").html(d).submit()}});$("#reason").autosize()},historyFilter=function(){return{op:"history_spisok",limit:$("#history_limit").val(),
worker_id:$("#history_worker_id").val(),cat_id:$("#history_cat_id").val(),client_id:$("#history_client_id").val(),zayav_id:$("#history_zayav_id").val()}},historySpisok=function(a,b){var c=historyFilter();c[b]=a;$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,c,function(a){$("#mainLinks").removeClass("busy");a.success&&$(".left").html(a.html)},"json")},incomeSpisok=function(){var a={op:"income_spisok",day:$(".selected").val(),income_id:$("#income_id").val(),worker_id:$("#worker_id").val()};$(".inc-path").addClass("_busy");
$.post(AJAX_MAIN,a,function(a){$(".inc-path").removeClass("_busy");a.success&&($(".inc-path").html(a.path),$("#spisok").html(a.html))},"json")},incomeChoiceSum=function(){var a,b=$("._money .choice"),c=0,d=0,g=!0,e=[];for(a=0;a<b.length;a++){var f=b.eq(a);1==f.find("input").val()?(c++,d+=1*f.parent().find(".sum").html().replace(" ",""),e.push(f.parent().attr("val"))):g=!1}$(".income_choice_sum").html(c?"Выбран"+_end(c,["","о"])+" <b>"+c+"</b> платеж"+_end(c,["","а","ей"])+" на сумму <b>"+d+"</b> руб.":
"");$("#money_all")._check(g);return{count:c,ids:e.join(),sum:d}},expenseFilter=function(){for(var a=[],b=$("#monthList input"),c=1;12>=c;c++)1==b.eq(c-1).val()&&a.push(c);return{op:"expense_spisok",category:$("#category").val(),worker:$("#worker").val(),invoice_id:$("#invoice_id").val(),year:$("#year").val(),month:a.join()}},expenseSpisok=function(){$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,expenseFilter(),function(a){$("#mainLinks").removeClass("busy");a.success&&($("#spisok").html(a.html),
$("#monthList").html(a.mon))},"json")};
$.fn.clientSel=function(a){function b(d){d={op:"client_sel",val:d||"",client_id:a.client_id};c._select("process");$.post(AJAX_MAIN,d,function(d){c._select("cancel");d.success&&(c._select(d.spisok),a.client_id&&(c._select(a.client_id),a.client_id=0))},"json")}var c=$(this);a=$.extend({width:270,add:null,client_id:c.val()||0,func:function(){}},a);a.add&&(a.add=function(){clientAdd(function(a){var b=[];b.push(a);c._select(b);c._select(a.uid)})});c._select({width:a.width,title0:"Начните вводить данные клиента...",
spisok:[],write:1,nofind:"Клиентов не найдено",func:a.func,funcAdd:a.add,funcKeyup:b});b();return c};
$.fn.productList=function(a){function b(a){var d=g+e,b=d+"id",f=d+"subid",h=d+"count";m.before('<table id="ptab'+e+'" class="ptab" val="'+e+'"><tr><td class="td"><input type="hidden" id="'+b+'" value="'+(a[0]||0)+'" /><input type="hidden" id="'+f+'" value="'+(a[1]||0)+'" /><td class="td"><input type="text" id="'+h+'" value="'+(a[2]||"")+'" class="count" maxlength="3" /> шт.'+(1<e?'<div class="img_del"></div>':"")+"</table>");var k=$("#ptab"+e);k.find(".img_del").click(function(){k.remove()});$("#"+
b)._select({width:119,title0:"Не указано",spisok:PRODUCT_SPISOK,func:function(a){$("#"+f)._select("remove").val(0);0<a&&PRODUCT_SUB_SPISOK[a]&&c(a,f,h);$("#"+h).val(0<a?1:"").focus()}});c(a[0]||0,f,h);e++}function c(a,d,b){0!=a&&PRODUCT_SUB_SPISOK[a]&&$("#"+d)._select({width:120,title0:"Подвид не указан",spisok:PRODUCT_SUB_SPISOK[a],func:function(){$("#"+b).focus()}})}var d=$(this),g=d.attr("id"),e=1,f;if("string"==typeof a&&"get"==a){a=d.find(".ptab");d=[];for(f=0;f<a.length;f++){var h=a.eq(f),k=
g+h.attr("val"),h=$("#"+k+"id").val(),l=$("#"+k+"subid").val(),k=$("#"+k+"count").val();if(0!=h){if(!REGEXP_NUMERIC.test(k)||0==k)return"count_error";d.push(h+":"+l+":"+k)}}return 0==d.length?!1:d.join()}d.html('<div class="_product-list"><a class="add">Добавить поле</a></div>');var m=d.find(".add");m.click(b);if("object"==typeof a)for(f=0;f<a.length;f++)b(a[f]);else b([]);return d};
$.fn.zayavRashod=function(a){function b(a){var c=d+g,e=c+"cat",f=c+"worker";p.append('<table id="ptab'+g+'" class="ptab" val="'+g+'"><tr><td><input type="hidden" id="'+e+'" value="'+(a[0]||0)+'" /><td class="tddop">'+(a[0]&&ZAYAVEXPENSE_TXT[a[0]]?'<input type="text" class="zrtxt" placeholder="описание не указано" tabindex="'+(10*g-1)+'" value="'+a[1]+'" />':"")+(a[0]&&ZAYAVEXPENSE_WORKER[a[0]]?'<input type="hidden" id="'+f+'" value="'+a[1]+'" />':"")+'<td class="tdsum'+(a[0]?"":" dn")+'"><input type="text" class="zrsum" maxlength="6" tabindex="'+
10*g+'" value="'+(a[2]||"")+'" />руб.</table>');var h=$("#ptab"+g),k=h.find(".tddop"),l=h.find(".zrsum");a[0]&&ZAYAVEXPENSE_WORKER[a[0]]&&$("#"+f)._select({width:150,title0:"Сотрудник",spisok:WORKER_SPISOK,func:function(){l.focus()}});$("#"+e)._select({width:120,title0:"Категория",spisok:ZAYAVEXPENSE_SPISOK,func:function(a){h.find(".tdsum")[(0<a?"remove":"add")+"Class"]("dn");ZAYAVEXPENSE_TXT[a]?(k.html('<input type="text" class="zrtxt" placeholder="описание не указано" tabindex="'+(10*g-11)+'" />'),
k.find(".zrtxt").focus()):(ZAYAVEXPENSE_WORKER[a]?(k.html('<input type="hidden" id="'+f+'" />'),$("#"+f)._select({width:150,title0:"Сотрудник",spisok:WORKER_SPISOK,func:function(){l.focus()}})):k.html(""),l.focus());l.val("");0<a&&!h.next().hasClass("ptab")&&b([])}});g++}var c=$(this),d=c.attr("id"),g=1,e;if("string"==typeof a&&"get"==a){a=c.find(".ptab");c=[];for(e=0;e<a.length;e++){var f=a.eq(e),h=d+f.attr("val"),k=$("#"+h+"cat").val();$("#"+h+"worker").val();var l=f.find(".zrsum").val(),m="";if(0!=
k){if(!REGEXP_NUMERIC.test(l)||0==l)return"sum_error";ZAYAVEXPENSE_TXT[k]?m=f.find(".zrtxt").val():ZAYAVEXPENSE_WORKER[k]&&(m=$("#"+h+"worker").val());c.push(k+":"+m+":"+l)}}return c.join()}c.html('<div class="_zayav-rashod"></div>');var p=c.find("._zayav-rashod");if("object"==typeof a)for(e=0;e<a.length;e++)b(a[e]);b([]);return c};
$(document).on("change","._attach input",function(){setCookie("_attached",0);for(var a=$(this);!a.hasClass("_attach");)a=a.parent();var b=a.find("form"),c=a.find(".form"),d=setInterval(function(){var g=getCookie("_attached");0<g&&(clearInterval(d),1==g?(g={op:"attach_get",type:b.find(".type").val(),zayav_id:b.find(".zayav_id").val()},$.post(AJAX_MAIN,g,function(d){c.removeClass("_busy");d.success&&(a.find(".files").html(d.files),b.html(d.form))},"json")):(c.removeClass("_busy"),c.next(".red").remove(),
c.after('<div class="red">Некорректный файл.</div>'),c.next(".red").fadeOut(4E3)))},500);c.addClass("_busy");b.submit()}).on("click","._attach .img_minidel",function(){var a=$(this),b={op:"attach_del",id:a.attr("val")};$.post(AJAX_MAIN,b,function(b){b.success&&(a.prev().remove(),a.remove())},"json")}).on("click",".accrual-del",function(){for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();if(!a.hasClass("deleting")){a.addClass("deleting");var b={op:"accrual_del",id:a.attr("val")};$.post(AJAX_MAIN,
b,function(c){a.removeClass("deleting");c.success&&(a.after('<tr class="deleted" val="'+b.id+'"><td colspan="4"><div>Начисление удалено. <a class="accrual-rest">Восстановить</a></div>'),a.addClass("dn"))},"json")}}).on("click",".accrual-rest",function(){for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();var b={op:"accrual_rest",id:a.attr("val")},c=a.find("div");c.hasClass("_busy")||(c.addClass("_busy"),$.post(AJAX_MAIN,b,function(d){c.removeClass("busy");d.success&&(a.prev().removeClass("dn"),a.remove())},
"json"))}).on("click","#client ._next",function(){var a=$(this),b=clientFilter();a.hasClass("busy")||(b.page=a.attr("val"),a.addClass("busy"),$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.spisok).remove():a.removeClass("busy")},"json"))}).on("click",".zayav_add",function(){_dialog({width:370,top:30,head:"Выберите категорию заявки",content:'<div class="zayav-add"><div class="item zakaz_add"><b>Заказ</b>Новый заказ для продажи изделий без установки.<br />При необходимости в будущем заказ можно будет перевести в Установку.</div><div class="item zamer_add"><b>Замер</b>Новая заявка на замер. Указывается дата и время замера. Заявка автоматически попадает в напоминания. Успешный замер переносится на заключение договора.</div><div class="item set_add"><b>Установка</b>Новая заявка на установку изделий.</div>',
butSubmit:""})}).on("click",".zayav_unit",function(){document.location.href=URL+"&p=zayav&d=info&id="+$(this).attr("val")}).on("click","#zayav ._next",function(){var a=$(this);if(!a.hasClass("busy")){var b=zayavFilter();b.op="zayav_next";b.page=a.attr("val");a.addClass("busy");$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json")}}).on("click","#zayav .filter_clear",function(){$(".find-hide").removeClass("dn");window.zFind.clear();$("#product_id")._select(0);
zayavSpisok()}).on("click",".zakaz_add",function(){window.CLIENT||(CLIENT={id:0,fio:"",adres:""});var a=_dialog({width:550,top:30,head:"Внесение нового заказа",content:'<table class="zayav-add"><tr><td class="label">Клиент:<td><INPUT type="hidden" id="client_id" value="'+CLIENT.id+'"><b>'+CLIENT.fio+'</b><tr><td class="label topi">Изделие:<td id="product"><tr><td><td><input type="text" id="zakaz_txt" placeholder="либо укажите содержание заказа вручную.." maxlength="300"><tr><td class="label top">Заметка:\t<td><textarea id="comm"></textarea></table>',
submit:function(){var b,c={op:"zakaz_add",client_id:$("#client_id").val(),product:$("#product").productList("get"),zakaz_txt:$("#zakaz_txt").val(),comm:$("#comm").val()};0==c.client_id?b="Не выбран клиент":c.product||c.zakaz_txt?"count_error"==c.product?b="Некорректно введено количество изделий":(a.process(),$.post(AJAX_MAIN,c,function(d){d.success?(a.close(),_msg("Заявка внесена"),location.href=URL+"&p=zayav&d=info&id="+d.id):a.abort()},"json")):b="Необходимо выбрать изделие или вписать заказ вручную";
b&&a.bottom.vkHint({msg:'<SPAN class="red">'+b+"</SPAN>",top:-48,left:171,indent:50,show:1,remove:1})}});CLIENT.id||$("#client_id").clientSel({add:1});$("#product").productList();$("#comm").autosize()}).on("click",".zakaz_status",function(){$(this);var a=_dialog({top:30,width:300,head:"Изменение статуса заказа",content:'<div class="zayav-status">'+(1!=ZAYAV.status?'<div class="st c1" val="1">Заказ ожидает выполнения<div class="about">Возобновление работы по заказу.</div></div>':"")+'<div class="st c2" val="2">Заказ выполнен<div class="about">Все начисления произведены, изделия переданы клиенту.</div><div class="label">Уточните день выполнения заказа:</div><input type="hidden" id="day" value="'+
(ZAYAV.status_day||"")+'"></div>'+(3!=ZAYAV.status?'<div class="st c3" val="3">Заказ отменён<div class="about">Отмена заказа по какой-либо причине.</div></div>':"")+"</div>",butSubmit:"",butCancel:"Закрыть"});$("#day")._calendar({lost:1});$(".st").click(function(){var b=$(this),c={op:"zakaz_status",zayav_id:ZAYAV.id,status:b.attr("val"),day:$("#day").val()||""},d=b.parent();d.hasClass("busy")||(d.addClass("busy"),$.post(AJAX_MAIN,c,function(b){b.success?(a.close(),_msg("Данные изменены!"),document.location.reload()):
d.removeClass("busy")},"json"))})}).on("click",".zamer_table",function(){var a=_dialog({width:600,top:10,head:"Таблица замеров",load:1,butSubmit:"",butCancel:"Закрыть"}),b={op:"zamer_table_get",val:$(this).attr("val")||0};$.post(AJAX_MAIN,b,function(b){b.success?a.content.html(b.html):a.loadError()},"json")}).on("click","#zamer-table .ztu",function(){document.location.href=URL+"&p=zayav&d=info&id="+$(this).attr("val")}).on("click","#zamer-table .mon a",function(){var a=$(this),b=a.parent(),a={op:"zamer_table_get",
mon:a.attr("val")};b.hasClass("_busy")||(b.addClass("_busy"),$.post(AJAX_MAIN,a,function(a){a.success?$("#zamer-table").parent().html(a.html):b.removeClass("_busy")},"json"))}).on("click",".zamer_add",function(){function a(a){c.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-48,left:185,indent:40,show:1,remove:1})}window.CLIENT||(CLIENT={id:0,fio:"",adres:""});var b=CLIENT.adres,c=_dialog({width:550,top:30,head:"Внесение новой заявки на замер",content:'<table class="zayav-add"><tr><td class="label">Клиент:<td><INPUT type="hidden" id="client_id" value="'+
CLIENT.id+'"><b>'+CLIENT.fio+'</b><tr><td class="label topi">Изделие:<td id="product"><tr><td class="label">Адрес проведения замера:<td><INPUT type="text" id="adres" maxlength="100" /><INPUT type="hidden" id="homeadres" /><tr><td class="label">Дата и время замера:<td class="zayav-zamer-dtime"><tr><td class="label">Длительность замера:<td><INPUT TYPE="hidden" id="zamer_duration" value="30" /><tr><td class="label top">Заметка:\t<td><textarea id="comm"></textarea></table>',submit:function(){var b={op:"zamer_add",
client_id:$("#client_id").val(),product:$("#product").productList("get"),adres:$("#adres").val(),zamer_day:$("#zamer_day").val(),zamer_hour:$("#zamer_hour").val(),zamer_min:$("#zamer_min").val(),zamer_duration:$("#zamer_duration").val(),comm:$("#comm").val()};0==b.client_id?a("Не выбран клиент"):b.product?"count_error"==b.product?a("Некорректно введено количество изделий"):b.adres?(c.process(),$.post(AJAX_MAIN,b,function(b){b.success?(c.close(),_msg("Заявка внесена"),location.href=URL+"&p=zayav&d=info&id="+
b.id):(c.abort(),a(b.text))},"json")):a("Не указан адрес"):a("Не указано изделие")}});CLIENT.id||$("#client_id").clientSel({add:1,func:function(a,c,e){b=a?e.adres:"";1==$("#homeadres").val()&&$("#adres").val(b)}});$("#product").productList();$("#homeadres")._check({func:function(){$("#adres").val(b)}});$("#homeadres_check").vkHint({msg:"Совпадает с адресом проживания",top:-75,left:193,indent:60,delayShow:700});zayavZamerDtime({});$("#comm").autosize()}).on("click",".zamer_status",function(){function a(a){g.content.html('<div class="zayav-status"><div class="st c1" val="1">Указать новое время<div class="about">Замер будет перенесён на другое время.</div></div><div class="st c2" val="2">Замер выполнен<div class="about">Замер выполнен успешно. Заявка будет переведена на заключение договора.</div></div>'+
(3!=a.status?'<div class="st c3" val="3">Отмена<div class="about">Отмена заявки по какой-либо причине.</div></div>':"")+'<table class="zstab"><tr><td class="label">Новое время:<td class="zayav-zamer-dtime"><tr><td class="label">Длительность:<td><INPUT TYPE="hidden" id="zamer_duration" value="'+a.dur+'" /><a class="zamer_table" val="'+d+'">Таблица замеров</a><tr><td><td><div class="vkButton"><button>Сохранить</button></div></table></div>');zayavZamerDtime(a);$(".st").click(function(){var a=$(this).attr("val");
1==a?($(".st").hide(),$(".zstab").show()):b(a)});$(".zayav-status .vkButton").click(function(){$(this).addClass("busy");b(1)})}function b(a){a={op:"zamer_status",zayav_id:d,status:a,zamer_day:$("#zamer_day").val(),zamer_hour:$("#zamer_hour").val(),zamer_min:$("#zamer_min").val(),zamer_duration:$("#zamer_duration").val()};$.post(AJAX_MAIN,a,function(a){a.success?(g.close(),_msg("Данные изменены!"),document.location.reload()):$(".zayav-status .vkButton").removeClass("busy").vkHint({msg:'<SPAN class="red">'+
a.text+"</SPAN>",top:-58,left:-5,indent:40,remove:1,show:1})},"json")}var c=$(this),d="undefined"!=typeof ZAYAV?ZAYAV.id:c.attr("val"),g=_dialog({width:400,top:30,head:"Изменение статуса замера",load:1,butSubmit:"",butCancel:"Закрыть"});"undefined"==typeof ZAYAV?$.post(AJAX_MAIN,{op:"zamer_info_get",zayav_id:d},function(b){b.success?a(b):g.loadError()},"json"):a(ZAYAV)}).on("click",".set_add",function(){window.CLIENT||(CLIENT={id:0,fio:"",adres:""});var a=CLIENT.adres,b=_dialog({width:550,top:30,
head:"Внесение новой заявки на установку",content:'<table class="zayav-add"><tr><td class="label">Клиент:<td><INPUT type="hidden" id="client_id" value="'+CLIENT.id+'"><b>'+CLIENT.fio+'</b><tr><td class="label topi">Изделие:<td id="product"><tr><td class="label">Адрес установки:<td><INPUT type="text" id="adres" maxlength="100" /><INPUT type="hidden" id="homeadres" /><tr><td class="label top">Заметка:\t<td><textarea id="comm"></textarea></table>',submit:function(){var a,d={op:"set_add",client_id:$("#client_id").val(),
product:$("#product").productList("get"),adres:$("#adres").val(),comm:$("#comm").val()};0==d.client_id?a="Не выбран клиент":d.product?"count_error"==d.product?a="Некорректно введено количество изделий":d.adres?(b.process(),$.post(AJAX_MAIN,d,function(a){a.success?(b.close(),_msg("Заявка внесена"),location.href=URL+"&p=zayav&d=info&id="+a.id):b.abort()},"json")):a="Не указан адрес":a="Не указано изделие";a&&b.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-48,left:171,indent:50,show:1,remove:1})}});
CLIENT.id||$("#client_id").clientSel({add:1,func:function(b,d,g){a=b?g.adres:"";1==$("#homeadres").val()&&$("#adres").val(a)}});$("#product").productList();$("#homeadres")._check({func:function(){$("#adres").val(a)}});$("#homeadres_check").vkHint({msg:"Совпадает с адресом проживания",top:-75,left:193,indent:60,delayShow:700});$("#comm").autosize()}).on("click",".set_status",function(){$(this);var a=_dialog({top:30,width:360,head:"Изменение статуса установки",content:'<div class="zayav-status">'+(1!=
ZAYAV.status?'<div class="st c1" val="1">Ожидает установку<div class="about">Возобновление работы по заявке.</div></div>':"")+'<div class="st c2" val="2">Установка выполнена<div class="about">Произведена установка всех изделий. Не забудьте расписать расходы по заявке и проверьте начисления.</div><div class="label">Уточните день выполнения установки:</div><input type="hidden" id="day" value="'+(ZAYAV.status_day||"")+'"></div>'+(3!=ZAYAV.status?'<div class="st c3" val="3">Заявка отменена<div class="about">Отмена заявки по какой-либо причине.</div></div>':
"")+"</div>",butSubmit:"",butCancel:"Закрыть"});$("#day")._calendar({lost:1});$(".st").click(function(){var b=$(this),c={op:"set_status",zayav_id:ZAYAV.id,status:b.attr("val"),day:$("#day").val()||""},d=b.parent();d.hasClass("busy")||(d.addClass("busy"),$.post(AJAX_MAIN,c,function(b){b.success?(a.close(),_msg("Данные изменены!"),document.location.reload()):d.removeClass("busy")},"json"))})}).on("click","#history_next",function(){var a=$(this),b=historyFilter();a.hasClass("busy")||(b.page=$(this).attr("val"),
a.addClass("busy"),$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json"))}).on("click",".invoice_set",function(){function a(){var a=[];if(e)for(n=0;n<g;n++){var d=h.eq(n).val();if(REGEXP_CENA.test(d))a.push(CASH[n].id+"="+1*d.replace(",","."));else{b("Некорректно указана сумма");h.eq(n).focus();return}}a={op:"invoice_set",invoice_id:c,sum:e?0:$("#sum").val(),cash:a.join(":")};e||REGEXP_CENA.test(a.sum)?(f.process(),$.post(AJAX_MAIN,a,function(a){a.success?
($("#cash-spisok").html(a.c),$("#invoice-spisok").html(a.i),f.close(),_msg("Баланс установлен.")):f.abort()},"json")):(b("Некорректно указана сумма"),$("#sum").focus())}function b(a){f.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",remove:1,indent:40,show:1,top:-48,left:72})}window.CASH||(window.CASH=[]);var c=$(this).attr("val"),d='<table class="_dialog-tab">',g=CASH.length,e="1"==c&&!!g;if(e){for(n=0;n<g;n++)d+='<tr><td class="label">'+CASH[n].name+':<td><INPUT type="text" class="money" maxlength="11" value="'+
CASH[n].sum+'"> руб.';d+='<tr><td class="label">Счёт <b>'+INVOICE_NAME+'</b>:<td><b id="summa">0</b> руб.'}else d+='<tr><td class="label">Сумма:<td><INPUT type="text" class="money" id="sum" maxlength="11"> руб.';var f=_dialog({width:320,head:"Установка текущей суммы счёта",content:d+"</table>",butSubmit:"Установить",submit:a}),h=f.content.find("input");h.eq(0).focus();h.keyEnter(a);e&&h.keyup(function(){var a=0;for(n=0;n<g;n++){var b=h.eq(n).val();if(REGEXP_CENA.test(b))a+=1*b.replace(",",".");else{a=
0;break}}$("#summa").html(a)})}).on("click","#report.invoice .img_note",function(){var a=_dialog({top:20,width:570,head:"История операций со счётом",load:1,butSubmit:"",butCancel:"Закрыть"}),b={op:"invoice_history",invoice_id:$(this).attr("val")};$.post(AJAX_MAIN,b,function(b){b.success?a.content.html(b.html):a.loadError()},"json")}).on("click",".invoice-history ._next",function(){var a=$(this),b={op:"invoice_history",page:a.attr("val"),invoice_id:$("#invoice_history_id").val()};a.hasClass("busy")||
(a.addClass("busy"),$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json"))}).on("click","#money_all_check",function(){for(var a=$(this),b=a.find("input").val();!a.hasClass("_money");)a=a.parent();for(var c=a.find("tr"),a=1;a<c.length;a++)c.eq(a).find("input:first")._check(b)}).on("click","._money ._check",incomeChoiceSum).on("click",".income-show",function(){var a=_dialog({top:20,width:480,head:"Просмотр платежей",load:1,butSubmit:"",butCancel:"Закрыть"}),
b={op:"income_transfer_show",ids:$(this).attr("val")};$.post(AJAX_MAIN,b,function(b){b.success?a.content.html(b.html):a.loadError()},"json")}).on("click",".income-confirm",function(){var a=_dialog({top:20,width:480,head:"Подтверждение платежей",load:1,butSubmit:"Подтвердить",submit:function(){var b={op:"income_confirm",ids:incomeChoiceSum().ids};b.ids?(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?($("#confirm-info").html(b.confirm),$("#cash-spisok").html(b.c),$("#invoice-spisok").html(b.i),
a.close(),_msg("Платежи подтверждены.")):a.abort()},"json")):a.bottom.vkHint({msg:'<SPAN class="red">Платежи не выбраны</SPAN>',remove:1,indent:50,show:1,top:-48,left:143})}});$.post(AJAX_MAIN,{op:"income_confirm_get"},function(b){b.success?a.content.html(b.html+'<div class="income_choice_sum"></div>'):a.loadError()},"json")}).on("click",".income-add",function(){function a(){var a={op:"income_add",from:OPL.from,type:$("#income_opl").val(),confirm:$("#confirm").val(),sum:$("#sum").val(),zayav_id:$("#zayav_id").val()||
0,client_id:OPL.client_id||0,prim:$.trim($("#prim").val())};0==a.type?b("Не указан вид платежа"):REGEXP_CENA.test(a.sum)&&0!=a.sum?$("#zayav_id").length&&0==a.zayav_id&&!a.prim?(b("Если не выбрана заявка, необходимо указать комментарий"),$("#prim").focus()):$("#zayav_id").length||a.prim?(d.process(),$.post(AJAX_MAIN,a,function(a){if(a.success)switch(d.close(),_msg("Платёж успешно внесён!"),OPL.from){case "client":$("#income_spisok").html(a.html);$(".left:first").html(a.balans);break;case "zayav":$("#income_spisok").html(a.html);
break;case "income":incomeSpisok()}else d.abort()},"json")):(b("Необходимо указать комментарий"),$("#prim").focus()):(b("Некорректно указана сумма."),$("#sum").focus())}function b(a){d.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",remove:1,indent:40,show:1,top:-48,left:135})}var c='<table class="income-add-tab">'+("income"!=OPL.from?'<tr><td class="label">Клиент:<td>'+OPL.client_fio+'<tr><td class="label">Заявка:<td><input type="hidden" id="zayav_id" value="'+(OPL.zayav_id?OPL.zayav_id:0)+'">'+
(OPL.zayav_id?"<b>№"+OPL.zayav_id+"</b>":""):"")+'<tr><td class="label">Вид платежа:<td><input type="hidden" id="income_opl"><a href="'+URL+'&p=setup&d=income" class="img_edit'+_tooltip("Настройка видов платежей",-85)+'</a><tr class="tr_confirm dn"><td class="label">Подтверждение:<td><input type="hidden" id="confirm"><tr><td class="label">Сумма:<td><input type="text" id="sum" class="money" maxlength="11"> руб.<tr><td class="label">Комментарий:<td><input type="text" id="prim" maxlength="100"></table>',
d=_dialog({top:60,width:440,head:"Внесение платежа",content:c,submit:a});$("#sum").focus();$("#sum,#prim").keyEnter(a);OPL.zayav_spisok&&$("#zayav_id")._select({width:210,title0:"Не указана",spisok:OPL.zayav_spisok});$("#income_opl")._select({width:180,title0:"Не указан",spisok:INCOME_SPISOK,func:function(a){$("#sum").focus();$(".tr_confirm")[(INCOME_CONFIRM[a]?"remove":"add")+"Class"]("dn");$("#confirm")._check(0)}});$("#confirm")._check();$("#confirm_check").vkHint({width:210,msg:"Установите галочку, если платёж нужно внести, но требуется подтверждение о его поступлении на счёт.",
top:-96,left:-100})}).on("click",".income-del",function(){for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();if(!a.hasClass("deleting")){a.addClass("deleting");var b={op:"income_del",id:a.attr("val")};$.post(AJAX_MAIN,b,function(b){a.removeClass("deleting");b.success&&a.addClass("deleted")},"json")}}).on("click",".income-rest",function(){for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();var b={op:"income_rest",id:a.attr("val")};$.post(AJAX_MAIN,b,function(b){b.success&&a.removeClass("deleted")},
"json")}).on("click","#income_next",function(){var a=$(this),b={op:"income_next",page:$(this).attr("val"),limit:$("#money_limit").val(),client_id:$("#money_client_id").val(),zayav_id:$("#money_zayav_id").val(),day:$(".selected").val()||""};a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json"))}).on("click",".expense #monthList div",expenseSpisok).on("click",".expense ._next",function(){var a=$(this),b=expenseFilter();
b.page=a.attr("val");a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json"))}).on("click",".expense .img_del",function(){for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();if(!a.hasClass("deleting")){a.addClass("deleting");var b={op:"expense_del",id:a.attr("val")};$.post(AJAX_MAIN,b,function(b){a.removeClass("deleting");b.success&&a.addClass("deleted")},"json")}}).on("click",".expense .img_rest",function(){for(var a=
$(this);"TR"!=a[0].tagName;)a=a.parent();var b={op:"expense_rest",id:a.attr("val")};$.post(AJAX_MAIN,b,function(b){b.success&&a.removeClass("deleted")},"json")}).on("click",".expense .img_edit",function(){function a(a){c.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",remove:1,indent:40,show:1,top:-47,left:101})}for(var b=$(this);"TR"!=b[0].tagName;)b=b.parent();var c=_dialog({width:380,head:"Редактирование расхода",load:1,butSubmit:"Сохранить",submit:function(){var b={id:d,op:"expense_edit",
category:1*$("#cat").val(),about:$("#about").val(),worker:$("#work").val(),invoice:1*$("#invoice").val(),sum:$("#sum").val()};b.category||b.about?b.invoice?REGEXP_NUMERIC.test(b.sum)?(c.process(),$.post(AJAX_MAIN,b,function(a){a.success?(c.close(),_msg("Расход изменён."),expenseSpisok()):c.abort()},"json")):(a("Некорректно указана сумма."),$("#sum").focus()):a("Укажите с какого счёта производится оплата."):(a("Выберите категорию или укажите описание."),$("#about").focus())}}),d=b.attr("val");$.post(AJAX_MAIN,
{op:"expense_get",id:d},function(a){c.content.html('<table id="expense-add-tab"><tr><td class="label">Категория:<td><input type="hidden" id="cat" value="'+a.category+'"><tr class="tr-work '+(EXPENSE_WORKER[a.category]?"":"dn")+'"><td class="label">Сотрудник:<td><input type="hidden" id="work" value="'+a.worker+'"><tr><td class="label">Описание:<td><input type="text" id="about" maxlength="150" value="'+a.about+'"><tr><td class="label">Со счёта:<td><input type="hidden" id="invoice" value="'+a.invoice+
'"><tr><td class="label">Сумма:<td><input type="text" id="sum" class="money" maxlength="8" value="'+a.sum+'"> руб.</table>');$("#cat")._select({width:180,title0:"Не указана",spisok:EXPENSE_SPISOK,func:function(a){$("#work")._select(0);$(".tr-work")[(EXPENSE_WORKER[a]?"remove":"add")+"Class"]("dn")}});$("#about").focus();$("#work")._select({title0:"Не выбран",spisok:WORKER_SPISOK});$("#invoice")._select({title0:"Не выбран",spisok:INVOICE_SPISOK,func:function(){$("#sum").focus()}})},"json")}).on("click",
"#report_month .yr",function(){$(this).next().toggle()}).on("click",".salary .rate-set",function(){function a(){var a={op:"salary_rate_set",worker:WORKER_ID,sum:$("#sum").val(),day:1*$("#day").val()};REGEXP_CENA.test(a.sum)?!REGEXP_NUMERIC.test(a.day)||!a.day||28<a.day?(b("Некорректно указан день."),$("#day").focus()):(c.process(),$.post(AJAX_MAIN,a,function(b){b.success?(RATE=a.sum,RATE_DAY=a.day,c.close(),_msg("Установка ставки произведена."),$("#spisok").html(b.html)):c.abort()},"json")):(b("Некорректно указана сумма."),
$("#sum").focus())}function b(a){c.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",remove:1,indent:40,show:1,top:-47,left:74})}var c=_dialog({top:30,width:320,head:"Установка ставки з/п для сотрудника",content:'<div class="_info">После установки ставки сотруднику указанная сумма будет автоматически начисляться на его баланс ежемесячно в определённый день. День начисления может быть выбран в промежутке от 1-го до 28 числа.</div><table class="salary-tab"><tr><td class="label">Сумма:<TD><INPUT type="text" id="sum" class="money" maxlength="11" value="'+
(RATE?RATE:"")+'" /> руб.<tr><td class="label">День начисления:<TD><INPUT type="text" id="day" maxlength="2" value="'+(RATE?RATE_DAY:"")+'" /></table>',butSubmit:"Установить",submit:a});$("#sum").focus();$("#sum,#day").keyEnter(a)}).on("click",".salary .up",function(){function a(){var a={op:"salary_up",worker:WORKER_ID,sum:$("#sum").val(),about:$("#about").val()};REGEXP_NUMERIC.test(a.sum)?(b.process(),$.post(AJAX_MAIN,a,function(a){a.success?(b.close(),_msg("Начисление произведено."),$("#spisok").html(a.html)):
b.abort()},"json")):(b.bottom.vkHint({msg:'<SPAN class="red">Некорректно указана сумма.</SPAN>',remove:1,indent:40,show:1,top:-47,left:93}),$("#sum").focus())}var b=_dialog({head:"Внесение начисления для сотрудника",content:'<table class="salary-tab"><tr><td class="label">Сумма:<TD><INPUT type="text" id="sum" class="money" maxlength="8"> руб.<tr><td class="label">Описание:<TD><INPUT type="text" id="about" maxlength="50"></table>',submit:a});$("#sum").focus();$("#sum,#about").keyEnter(a)}).on("click",
".salary .down",function(){function a(){var a={op:"salary_down",worker:WORKER_ID,invoice:1*$("#invoice").val(),sum:$("#sum").val(),about:$("#about").val()};a.invoice?REGEXP_NUMERIC.test(a.sum)?(d.process(),$.post(AJAX_MAIN,a,function(a){a.success?(d.close(),_msg("Выдача зарплаты произведена."),$("#spisok").html(a.html)):d.abort()},"json")):(b("Некорректно указана сумма."),$("#sum").focus()):b("Укажите с какого счёта производится выдача.")}function b(a){d.bottom.vkHint({msg:'<SPAN class="red">'+a+
"</SPAN>",remove:1,indent:40,show:1,top:-47,left:93})}var c='<table class="salary-tab"><tr><td class="label">Со счёта:<TD><INPUT type="hidden" id="invoice"><a href="'+URL+'&p=setup&d=invoice" class="img_edit'+_tooltip("Настройка счетов",-56)+'</a><tr><td class="label">Сумма:<TD><INPUT type="text" id="sum" class="money" maxlength="8"> руб.<tr><td class="label">Описание:<TD><INPUT type="text" id="about" maxlength="100"></table>',d=_dialog({head:"Выдача зарплаты сотруднику",content:c,submit:a});$("#sum").focus();
$("#invoice")._select({title0:"Не выбран",spisok:INVOICE_SPISOK,func:function(){$("#sum").focus()}});$("#sum,#about").keyEnter(a)}).on("click",".salary .deduct",function(){function a(){var a={op:"salary_deduct",worker:WORKER_ID,sum:$("#sum").val(),about:$("#about").val()};REGEXP_NUMERIC.test(a.sum)?(b.process(),$.post(AJAX_MAIN,a,function(a){a.success?(b.close(),_msg("Вычет произведён."),$("#spisok").html(a.html)):b.abort()},"json")):(b.bottom.vkHint({msg:'<SPAN class="red">Некорректно указана сумма.</SPAN>',
remove:1,indent:40,show:1,top:-47,left:93}),$("#sum").focus())}var b=_dialog({head:"Внесение вычета из зарплаты",content:'<table class="salary-tab"><tr><td class="label">Сумма:<TD><INPUT type="text" id="sum" class="money" maxlength="8"> руб.<tr><td class="label">Описание:<TD><INPUT type="text" id="about" maxlength="100"></table>',submit:a});$("#sum").focus();$("#sum,#about").keyEnter(a)}).on("click",".salary .start-set",function(){function a(){var a={op:"salary_start_set",worker:WORKER_ID,sum:$("#sum").val()};
REGEXP_CENA.test(a.sum)?(b.process(),$.post(AJAX_MAIN,a,function(a){a.success?(b.close(),_msg("Установка произведёна."),$("#spisok").html(a.html)):b.abort()},"json")):(b.bottom.vkHint({msg:'<SPAN class="red">Некорректно указана сумма.</SPAN>',remove:1,indent:40,show:1,top:-47,left:93}),$("#sum").focus())}var b=_dialog({head:"Установка баланса по зарплате сотрудника",content:'<table class="salary-tab"><tr><td class="label">Сумма:<TD><INPUT type="text" id="sum" class="money" maxlength="8"> руб.</table>',
butSubmit:"Применить",submit:a});$("#sum").focus().keyEnter(a)}).on("click",".salary ._next",function(){var a=$(this),b={op:"salary_spisok",page:$(this).attr("val"),worker_id:WORKER_ID};a.hasClass("busy")||(a.addClass("busy"),$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json"))}).ready(function(){$("#pin-enter").length&&($("#pin").focus().keydown(function(){$(".red").html("&nbsp;")}).keyEnter(pinEnter),$(".vkButton").click(pinEnter));$("#client").length&&
(window.cFind=$("#find")._search({width:602,focus:1,enter:1,txt:"Начните вводить данные клиента",func:clientSpisok}),$("#buttonCreate").vkHint({msg:'<B>Внесение нового клиента в базу.</B><br /><br />После внесения Вы попадаете на страницу с информацией о клиенте для дальнейших действий.<br /><br />Клиентов также можно добавлять при <A href="'+URL+'&p=zayav&d=add&back=client">создании новой заявки</A>.',ugol:"right",width:215,top:-38,left:-250,indent:40,delayShow:1E3,correct:0}).click(clientAdd),$("#dolg")._check(clientSpisok),
$("#dolg_check").vkHint({msg:"<b>Список должников.</b><br /><br />Выводятся клиенты, у которых баланс менее 0. Также в результате отображается общая сумма долга.",ugol:"right",width:150,top:-6,left:-185,indent:20,delayShow:1E3,correct:0}),$("#note")._check(clientSpisok),$("#product_id")._select({width:140,title0:"Любые изделия",spisok:PRODUCT_SPISOK,func:clientSpisok}));$("#clientInfo").length&&($("#dopLinks .link").click(function(){$("#dopLinks .link").removeClass("sel");$(this).addClass("sel");
var a=$(this).attr("val");$(".res").css("display","zayav"==a?"block":"none");$("#zayav_filter").css("display","zayav"==a?"block":"none");$("#zayav_spisok").css("display","zayav"==a?"block":"none");$("#income_spisok").css("display","money"==a?"block":"none");$("#remind_spisok").css("display","remind"==a?"block":"none");$("#comments").css("display","comm"==a?"block":"none");$("#histories").css("display","hist"==a?"block":"none")}),$(".cedit").click(function(){function a(){var d={op:"client_edit",client_id:CLIENT.id,
fio:$("#fio").val(),telefon:$("#telefon").val(),adres:$("#adres").val(),pasp_seria:$("#pasp_seria").val(),pasp_nomer:$("#pasp_nomer").val(),pasp_adres:$("#pasp_adres").val(),pasp_ovd:$("#pasp_ovd").val(),pasp_data:$("#pasp_data").val()};d.fio?(b.process(),$.post(AJAX_MAIN,d,function(a){a.success?(CLIENT=a,$(".left:first").html(a.html),b.close(),_msg("Данные клиента изменены.")):b.abort()},"json")):(b.bottom.vkHint({msg:'<span class="red">Не указано имя клиента.</span>',top:-47,left:100,indent:50,
show:1,remove:1}),$("#fio").focus())}var b=_dialog({head:"Редактирование данных клиента",top:30,width:380,content:'<table class="client-add"><tr><td class="label">Имя:<td><input type="text" id="fio" maxlength="100" value="'+CLIENT.fio+'"><tr><td class="label">Телефон:<td><input type="text" id="telefon" maxlength="100" value="'+CLIENT.telefon+'"><tr><td class="label">Адрес:<td><input type="text" id="adres" maxlength="100" value="'+CLIENT.adres+'"><tr><td><td><b>Паспортные данные:</b><tr><td class="label">Серия:<td><input type="text" id="pasp_seria" maxlength="8" value="'+
CLIENT.pasp_seria+'"><span class="label">Номер:</span><input type="text" id="pasp_nomer" maxlength="10" value="'+CLIENT.pasp_nomer+'"><tr><td class="label">Прописка:<td><input type="text" id="pasp_adres" maxlength="100" value="'+CLIENT.pasp_adres+'"><tr><td class="label">Кем выдан:<td><input type="text" id="pasp_ovd" maxlength="100" value="'+CLIENT.pasp_ovd+'"><tr><td class="label">Когда выдан:<td><input type="text" id="pasp_data" maxlength="100" value="'+CLIENT.pasp_data+'"></table>',butSubmit:"Сохранить",
submit:a});$("#fio,#telefon,#adres,#pasp_seria,#pasp_nomer,#pasp_adres,#pasp_ovd,#pasp_data").keyEnter(a)}),$(".cdel").click(function(){var a=_dialog({top:90,width:300,head:"Удаление клиента",content:"<center>Внимание!<br />Будут удалены все данные о клиенте,<br />его заявки, платежи и задачи.<br /><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){var b={op:"client_del",id:CLIENT.id};a.process();$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Клиент удален!"),
location.href=URL+"&p=client"):a.abort()},"json")}})}),$("#status").rightLink(clientZayavSpisokLoad));if($("#zayav").length){window.zFind=$("#find")._search({width:153,focus:1,txt:"Быстрый поиск...",enter:1,func:zayavFindFast});$("#status").rightLink(zayavSpisok);for(var a=[],b=0;b<PRODUCT_IDS.length;b++){var c=PRODUCT_IDS[b];a.push({uid:c,title:PRODUCT_ASS[c]})}$("#product_id")._select({width:155,title0:"Любые изделия",spisok:a,func:zayavSpisok})}$(".zayav-info").length&&($(".zinfo").click(function(){$(this).parent().find(".sel").removeClass("sel");
$(this).addClass("sel");$(".zayav-info").removeClass("h")}),$(".hist").click(function(){$(this).parent().find(".sel").removeClass("sel");$(this).addClass("sel");$(".zayav-info").addClass("h")}),$(".dogovor_create").click(dogovorCreate),$(".dogovor_no_require").click(function(){$.post(AJAX_MAIN,{op:"dogovor_no_require",zayav_id:ZAYAV.id},function(a){a.success&&document.location.reload()},"json")}),$("#dogovor_action")._dropdown({head:"Не заключен",spisok:[{uid:1,title:"Заключить договор"},{uid:2,title:'Перевести заявку в категорию "Требуется договор"'}],
nosel:1,func:function(a){1==a&&dogovorCreate();2==a&&$.post(AJAX_MAIN,{op:"dogovor_require",zayav_id:ZAYAV.id},function(a){a.success&&document.location.reload()},"json")}}),$("#dogovor_reaction")._dropdown({head:"Действие",headgrey:1,spisok:[{uid:1,title:"Изменение данных договора"},{uid:2,title:"Перезаключение"},{uid:3,title:"Расторжение"}],nosel:1,func:function(a){1==a&&dogovorCreate("edit");2==a&&dogovorCreate("reneg")}}),$(".zakaz_edit").click(function(){function a(){var d,c={op:"zakaz_edit",
zayav_id:ZAYAV.id,product:$("#product").productList("get"),zakaz_txt:$("#zakaz_txt").val(),nomer_vg:$("#nomer_vg").val(),nomer_g:$("#nomer_g").val(),nomer_d:$("#nomer_d").val()};c.product||c.zakaz_txt?"count_error"==c.product?d="Некорректно введено количество изделий":(b.process(),$.post(AJAX_MAIN,c,function(a){a.success?(b.close(),_msg("Данные изменены!"),document.location.reload()):b.abort()},"json")):d="Необходимо выбрать изделие или вписать заказ вручную";d&&b.bottom.vkHint({msg:'<SPAN class="red">'+
d+"</SPAN>",top:-47,left:161,indent:40,show:1,remove:1})}var b=_dialog({width:500,top:30,head:ZAYAV.head+" - Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label">Клиент:      <td>'+ZAYAV.client_fio+'<tr><td class="label topi">Изделие:<td id="product"><tr><td><td><input type="text" id="zakaz_txt" placeholder="либо укажите содержание заказа вручную.." maxlength="300" value="'+ZAYAV.zakaz_txt+'"><tr><td class="label">Номер ВГ:\t   <td><INPUT type="text" id="nomer_vg" maxlength="30" value="'+
ZAYAV.nomer_vg+'" /><tr><td class="label">Номер Ж: \t   <td><INPUT type="text" id="nomer_g" maxlength="30" value="'+ZAYAV.nomer_g+'" /><tr><td class="label">Номер Д: \t   <td><INPUT type="text" id="nomer_d" maxlength="30" value="'+ZAYAV.nomer_d+'" /></table>',butSubmit:"Сохранить",submit:a});$("#product").productList(ZAYAV.product);$("#zakaz_txt").keyEnter(a)}),$(".zamer_edit").click(function(){function a(d){b.bottom.vkHint({msg:'<SPAN class="red">'+d+"</SPAN>",top:-47,left:161,indent:40,show:1,remove:1})}
var b=_dialog({width:500,top:30,head:ZAYAV.head+" - Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label">Клиент:        <td>'+ZAYAV.client_fio+'<tr><td class="label top">Изделие:\t<td id="product"><tr><td class="label">Адрес замера:  <td><INPUT type="text" id="adres" maxlength="100" value="'+ZAYAV.adres+'" /><tr><td class="label">Дата и время замера:<td class="zayav-zamer-dtime"><tr><td class="label">Длительность замера:<td><INPUT TYPE="hidden" id="zamer_duration" value="'+
ZAYAV.dur+'" /><a class="zamer_table" val="'+ZAYAV.id+'">Таблица замеров</a></table>',butSubmit:"Сохранить",submit:function(){var c={op:"zamer_edit",zayav_id:ZAYAV.id,product:$("#product").productList("get"),adres:$("#adres").val(),zamer_day:$("#zamer_day").val(),zamer_hour:$("#zamer_hour").val(),zamer_min:$("#zamer_min").val(),zamer_duration:$("#zamer_duration").val()};c.product?"count_error"==c.product?a("Некорректно введено количество изделий"):c.adres?(b.process(),$.post(AJAX_MAIN,c,function(c){c.success?
(b.close(),_msg("Данные изменены!"),document.location.reload()):(b.abort(),a(c.text))},"json")):a("Не указан адрес"):a("Не указано изделие")}});$("#product").productList(ZAYAV.product);zayavZamerDtime(ZAYAV)}),$(".dog_edit").click(function(){var a=_dialog({width:500,top:30,head:"Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label">Клиент:      <td>'+ZAYAV.client_fio+'<tr><td class="label top">Изделие:\t<td id="product"><tr><td class="label">Адрес установки:<td><INPUT type="text" id="adres" maxlength="100" value="'+
ZAYAV.adres+'" /></table>',butSubmit:"Сохранить",submit:function(){var b,c={op:"dog_edit",zayav_id:ZAYAV.id,product:$("#product").productList("get"),adres:$("#adres").val()};c.product?"count_error"==c.product?b="Некорректно введено количество изделий":c.adres?(a.process(),$.post(AJAX_MAIN,c,function(b){b.success?(a.close(),_msg("Данные изменены!"),document.location.reload()):a.abort()},"json")):b="Не указан адрес":b="Не указано изделие";b&&a.bottom.vkHint({msg:'<SPAN class="red">'+b+"</SPAN>",top:-47,
left:161,indent:40,show:1,remove:1})}});$("#product").productList(ZAYAV.product)}),$(".set_edit").click(function(){function a(){var d,c={op:"set_edit",zayav_id:ZAYAV.id,product:$("#product").productList("get"),adres:$("#adres").val(),nomer_vg:$("#nomer_vg").val(),nomer_g:$("#nomer_g").val(),nomer_d:$("#nomer_d").val()};c.product?"count_error"==c.product?d="Некорректно введено количество изделий":c.adres?(b.process(),$.post(AJAX_MAIN,c,function(a){a.success?(b.close(),_msg("Данные изменены!"),document.location.reload()):
b.abort()},"json")):d="Не указан адрес":d="Не указано изделие";d&&b.bottom.vkHint({msg:'<SPAN class="red">'+d+"</SPAN>",top:-47,left:161,indent:40,show:1,remove:1})}var b=_dialog({width:500,top:30,head:ZAYAV.head+" - Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label">Клиент:      <td>'+ZAYAV.client_fio+'<tr><td class="label top">Изделие:\t<td id="product"><tr><td class="label">Адрес установки:<td><INPUT type="text" id="adres" maxlength="100" value="'+ZAYAV.adres+'" /><tr><td class="label">Номер ВГ:\t   <td><INPUT type="text" id="nomer_vg" maxlength="30" value="'+
ZAYAV.nomer_vg+'" /><tr><td class="label">Номер Ж: \t   <td><INPUT type="text" id="nomer_g" maxlength="30" value="'+ZAYAV.nomer_g+'" /><tr><td class="label">Номер Д: \t   <td><INPUT type="text" id="nomer_d" maxlength="30" value="'+ZAYAV.nomer_d+'" /></table>',butSubmit:"Сохранить",submit:a});$("#product").productList(ZAYAV.product);$("#adres,#nomer_vg,#nomer_g,#nomer_d").keyEnter(a)}),$(".acc-add").click(function(){function a(){var d,c={op:"accrual_add",zayav_id:ZAYAV.id,sum:$("#sum").val(),prim:$("#prim").val()};
REGEXP_CENA.test(c.sum)?(b.process(),$.post(AJAX_MAIN,c,function(a){b.abort();a.success&&(b.close(),_msg("Начисление успешно произведено."),$("#income_spisok").html(a.html))},"json")):(d="Некорректно указана сумма.",$("#sum").focus());d&&b.bottom.vkHint({msg:'<SPAN class="red">'+d+"</SPAN>",top:-48,left:123,indent:40,remove:1,show:1,correct:0})}var b=_dialog({top:60,width:420,head:"Начисление",content:'<TABLE class="accrual-add"><tr><td class="label">Сумма: <td><input type="text" id="sum" class="money" maxlength="6" /> руб.<tr><td class="label">Примечание:<em>(не обязательно)</em><td><input type="text" id="prim" maxlength="100" /></TABLE>',
submit:a});$("#sum").focus();$("#sum,#prim").keyEnter(a)}),$(".delete").click(function(){var a=_dialog({top:110,width:250,head:"Удаление заявки",content:"<CENTER>Подтвердите удаление заявки.</CENTER>",butSubmit:"Удалить",submit:function(){var b={op:"zayav_delete",zayav_id:ZAYAV.id};a.process();$.post(AJAX_MAIN,b,function(a){a.success&&(location.href=URL+"&p=client&d=info&id="+a.client_id)},"json")}})}),$(".rashod-edit").click(function(){var a=_dialog({width:470,top:30,head:"Изменение расходов заявки",
content:'<table class="zayav-rashod-edit"><tr><td class="label">Заявка: <td><b>'+ZAYAV.head+'</b><tr><td class="label topi">Расходы:<td id="zrs"></table>',butSubmit:"Сохранить",submit:function(){var b={op:"zayav_expense_edit",zayav_id:ZAYAV.id,rashod:$("#zrs").zayavRashod("get")};"sum_error"==b.rashod?a.bottom.vkHint({msg:'<SPAN class="red">Некорректно указана сумма</SPAN>',top:-47,left:147,indent:40,show:1,remove:1}):(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?($(".zrashod").html(b.html),
ZAYAV.rashod=b.array,a.close(),_msg("Сохранено.")):a.abort()},"json"))}});$("#zrs").zayavRashod(ZAYAV.rashod)}),$(".zakaz-to-set").click(function(){function a(){var d={op:"zakaz_to_set",zayav_id:ZAYAV.id,adres:$("#adres").val()};d.adres?(b.process(),$.post(AJAX_MAIN,d,function(a){b.abort();a.success&&(b.close(),_msg("Выполнено."),document.location.reload())},"json")):(b.bottom.vkHint({msg:'<SPAN class="red">Не указан адрес установки</SPAN>',top:-48,left:113,indent:40,remove:1,show:1,correct:0}),$("#adres").focus())}
var b=_dialog({top:60,width:400,head:"Перенос заказа в установку",content:'<table class="_dialog-tab"><tr><td class="label">Клиент:<td>'+ZAYAV.client_fio+'<tr><td class="label">Адрес установки:<td><INPUT type="text" id="adres" maxlength="100" value="'+ZAYAV.adres+'" /><INPUT type="hidden" id="homeadres" /></table>',butSubmit:"Перенести",submit:a});$("#adres").focus().keyEnter(a);$("#homeadres")._check({func:function(){$("#adres").val(ZAYAV.client_adres)}});$("#homeadres_check").vkHint({msg:"Совпадает с адресом проживания клиента",
top:-75,left:163,indent:60,delayShow:400})}));$("#remind").length&&($(".goyear").click(function(){$("#remind").addClass("y")}),window._calendarFilter=function(a){var b=$("#remind").hasClass("y"),c=$("#remind .right ._calendarFilter");a={op:"remind_day",day:a};b&&$("#remind").removeClass("y");$.post(AJAX_MAIN,a,function(a){a.success&&($("#remind .left").html(a.html),b&&c.html(a.cal))},"json")});$("#report.history").length&&($("#worker_id")._select({width:160,title0:"Все сотрудники",spisok:WORKERS,
func:historySpisok}),$("#cat_id")._select({width:160,title0:"Любая категория",spisok:HISTORY_GROUP,func:historySpisok}));$("#report.income").length&&(window._calendarFilter=incomeSpisok,$("#income_id")._select({width:160,title0:"Любые платежи",spisok:INCOME_SPISOK,func:incomeSpisok}),window.WORKERS&&$("#worker_id")._select({width:160,title0:"Все сотрудники",spisok:WORKERS,func:incomeSpisok}));$("#report.expense").length&&($(".add").click(function(){function a(){var d={op:"expense_add",category:1*
$("#cat").val(),about:$("#about").val(),worker:$("#work").val(),invoice:1*$("#invoice").val(),sum:$("#sum").val()};d.category||d.about?d.invoice?REGEXP_CENA.test(d.sum)&&0!=d.sum?(f.process(),$.post(AJAX_MAIN,d,function(a){a.success?(f.close(),_msg("Новый расход внесён."),expenseSpisok()):f.abort()},"json")):(b("Некорректно указана сумма."),$("#sum").focus()):b("Укажите с какого счёта производится оплата."):(b("Выберите категорию или укажите описание."),$("#about").focus())}function b(a){f.bottom.vkHint({msg:'<SPAN class="red">'+
a+"</SPAN>",remove:1,indent:40,show:1,top:-47,left:101})}var c='<table id="expense-add-tab"><tr><td class="label">Категория:<TD><INPUT type="hidden" id="cat"><a href="'+URL+'&p=setup&d=expense" class="img_edit'+_tooltip("Настройка категорий расходов",-95)+'</a><tr class="tr-work dn"><td class="label">Сотрудник:<TD><INPUT type="hidden" id="work"><tr><td class="label">Описание:<TD><INPUT type="text" id="about" maxlength="100"><tr><td class="label">Со счёта:<TD><INPUT type="hidden" id="invoice"><a href="'+
URL+'&p=setup&d=invoice" class="img_edit'+_tooltip("Настройка счетов",-56)+'</a><tr><td class="label">Сумма:<TD><INPUT type="text" id="sum" class="money" maxlength="11"> руб.</table>',f=_dialog({width:380,head:"Внесение расхода",content:c,submit:a});$("#cat")._select({width:180,title0:"Не указана",spisok:EXPENSE_SPISOK,func:function(a){$("#work")._select(0);$(".tr-work")[(EXPENSE_WORKER[a]?"remove":"add")+"Class"]("dn")}});$("#about").focus();$("#work")._select({title0:"Не выбран",spisok:WORKER_SPISOK});
$("#invoice")._select({title0:"Не выбран",spisok:INVOICE_SPISOK,func:function(){$("#sum").focus()}});$("#sum,#about").keyEnter(a)}),$("#category")._select({width:160,title0:"Любая категория",spisok:EXPENSE_SPISOK,func:expenseSpisok}),$("#worker")._select({width:160,title0:"Все сотрудники",spisok:WORKERS,func:expenseSpisok}),$("#invoice_id")._select({width:160,title0:"Любой счёт",spisok:INVOICE_SPISOK,func:expenseSpisok}),$("#year").years({func:expenseSpisok,center:function(){var a=$("#monthList input"),
c=0;for(b=1;12>=b;b++)if(0==a.eq(b-1).val()){c=1;break}for(b=1;12>=b;b++)$("#c"+b)._check(c);expenseSpisok()}}));$("#report.invoice").length&&$(".transfer").click(function(){function a(){var b={op:"invoice_transfer",from:1*$("#from").val(),to:1*$("#to").val(),sum:$("#sum").val(),ids:$("#ids").val()};b.from?b.to?b.from==b.to?c("Выберите другой счёт"):REGEXP_CENA.test(b.sum)&&0!=b.sum?(e.process(),$.post(AJAX_MAIN,b,function(a){a.success?($("#cash-spisok").html(a.c),$("#invoice-spisok").html(a.i),$("#transfer-spisok").html(a.t),
e.close(),_msg("Перевод произведён.")):e.abort()},"json")):(c("Некорректно введена сумма"),$("#sum").focus()):c("Выберите счёт-получатель"):c("Выберите счёт-отправитель")}function c(a,b){e.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:b?-95:-47,left:b?197:92,indent:50,show:1,remove:1})}$(this);var e=_dialog({width:380,head:"Перевод между счетами",content:'<table class="invoice-transfer"><tr><td class="label">Со счёта:<td><input type="hidden" id="from" /><tr><td class="label">На счёт:<td><input type="hidden" id="to" /><tr><td class="label">Сумма:<td><input type="text" id="sum" class="money" /> руб. <a class="income-choice">Выбрать платежи</a><input type="hidden" id="ids" /></table>',
butSubmit:"Применить",submit:a});if(window.CASH_SPISOK&&!window.CSMOVE){for(b=0;b<INVOICE_SPISOK.length;b++)1!=INVOICE_SPISOK[b].uid&&CASH_SPISOK.push(INVOICE_SPISOK[b]);INVOICE_SPISOK=CASH_SPISOK;window.CSMOVE=1}$("#from")._select({width:250,title0:"Не выбран",spisok:INVOICE_SPISOK});$("#to")._select({width:250,title0:"Не выбран",spisok:INVOICE_SPISOK});$("#sum").keyEnter(a);$("#sum").keyup(function(){$("#ids").val()&&($(".income-choice").html("Выбрать платежи"),$("#ids").val(""),$("#sum").val(""))});
$(".income-choice").click(function(){function a(){var c=incomeChoiceSum();$("#ids").val(c.ids);$(".income-choice").html(c.count+" платеж"+_end(c.count,["","а","ей"]));$("#sum").val(c.sum);b.close()}if(0==$("#from").val())c("Не выбран счёт-отправитель",1);else{var b=_dialog({top:20,width:480,head:"Выбор платежей для перевода",load:1,butSubmit:"Готово",submit:a}),d={op:"income_choice",owner_id:$("#from").val(),ids:$("#ids").val()};$.post(AJAX_MAIN,d,function(a){a.success?(b.content.html(a.html+'<div class="income_choice_sum"></div>'),
incomeChoiceSum()):b.loadError()},"json")}})})});
