var hashLoc,hashSet=function(a){if(a||a.p){hashLoc=a.p;var b=!0;switch(a.p){case "client":"info"==a.d&&(hashLoc+="_"+a.id);break;case "zayav":"info"==a.d?hashLoc+="_"+a.id:"add"==a.d?hashLoc+="_add"+(REGEXP_NUMERIC.test(a.id)?"_"+a.id:""):a.d||(b=!1);break;default:a.d&&(hashLoc+="_"+a.d,a.d1&&(hashLoc+="_"+a.d1))}b&&VK.callMethod("setLocation",hashLoc)}},clientAdd=function(a){function b(){var b={op:"client_add",fio:$("#fio").val(),telefon:$("#telefon").val(),adres:$("#adres").val(),pasp_seria:$("#pasp_seria").val(),
pasp_nomer:$("#pasp_nomer").val(),pasp_adres:$("#pasp_adres").val(),pasp_ovd:$("#pasp_ovd").val(),pasp_data:$("#pasp_data").val()};b.fio?(dialog.process(),$.post(AJAX_MAIN,b,function(b){b.success?(dialog.close(),_msg("Новый клиент внесён."),"function"==typeof a?a(b):document.location.href=URL+"&p=client&d=info&id="+b.uid):dialog.abort()},"json")):(dialog.bottom.vkHint({msg:'<SPAN class="red">Не указано имя клиента.</SPAN>',top:-47,left:103,indent:40,show:1,remove:1}),$("#fio").focus())}dialog=_dialog({top:60,
width:380,head:"Добавление нoвого клиента",content:'<table class="client-add"><tr><td class="label">Имя:<td><input type="text" id="fio" maxlength="100"><tr><td class="label">Телефон:<td><input type="text" id="telefon" maxlength="100"><tr><td class="label">Адрес:<td><input type="text" id="adres" maxlength="100"><tr class="tr_pasp"><td colspan="2"><a>Заполнить паспортные данные</a><tr class="dn"><td><td><b>Паспортные данные:</b><tr class="dn"><td class="label">Серия:<td><input type="text" id="pasp_seria" maxlength="8"><span class="label">Номер:</span><input type="text" id="pasp_nomer" maxlength="10"><tr class="dn"><td class="label">Прописка:<td><input type="text" id="pasp_adres" maxlength="100"><tr class="dn"><td class="label">Кем выдан:<td><input type="text" id="pasp_ovd" maxlength="100"><tr class="dn"><td class="label">Когда выдан:<td><input type="text" id="pasp_data" maxlength="100"></table>',
submit:b});$("#fio").focus();$("#fio,#telefon,#adres").keyEnter(b);$(".tr_pasp a").click(function(){$(".tr_pasp").remove();$(".client-add .dn").removeClass("dn");$("#pasp_seria").focus()})},clientFilter=function(){var a={fast:cFind.inp(),dolg:$("#dolg").val()};$(".filter")[a.fast?"hide":"show"]();return a},clientSpisokLoad=function(){var a=clientFilter(),b=$(".result");a.op="client_spisok_load";b.hasClass("busy")||(b.addClass("busy"),$.post(AJAX_MAIN,a,function(a){b.removeClass("busy");a.success&&
(b.html(a.all),$(".left").html(a.spisok))},"json"))},clientZayavFilter=function(){return{client:CLIENT.id,status:$("#status").val()}},clientZayavSpisokLoad=function(){var a=clientZayavFilter();a.op="client_zayav_load";$("#dopLinks").addClass("busy");$.post(AJAX_MAIN,a,function(a){$("#dopLinks").removeClass("busy");$("#zayav_result").html(a.all);$("#zayav_spisok").html(a.html)},"json")},zayavZamerDtime=function(a){a=$.extend({day:"",hour:10,min:0},a);a='<table><tr><td><INPUT TYPE="hidden" id="zamer_day" value="'+
a.day+'" /><td><INPUT TYPE="hidden" id="zamer_hour" value="'+a.hour+'" /><td> : <td><INPUT TYPE="hidden" id="zamer_min" value="'+a.min+'" /></table>';$(".zayav-zamer-dtime").html(a);$("#zamer_day")._calendar();$("#zamer_hour")._select({width:40,spisok:ZAMER_HOUR});$("#zamer_min")._select({width:40,spisok:ZAMER_MIN});$("#zamer_duration")._select({width:100,spisok:ZAMER_DURATION})},zakazFilter=function(){return{find:$.trim($("#find input").val())}},zamerFilter=function(){return{find:$.trim($("#find input").val())}},
zayavSpisokLoad=function(){var a=zayavFilter();$(".condLost")[(a.find?"add":"remove")+"Class"]("hide");a.op="zayav_spisok_load";$("#mainLinks").addClass("busy");$.post(AJAX_MAIN,a,function(a){$("#zayav .result").html(a.all);$("#zayav #spisok").html(a.html);$("#mainLinks").removeClass("busy")},"json")},dogovorFilter=function(){return{find:$.trim($("#find input").val())}},dogovorCreate=function(){function a(a){var c={id:DOG.id,zayav_id:ZAYAV.id,fio:$("#fio").val(),adres:$("#adres").val(),pasp_seria:$("#pasp_seria").val(),
pasp_nomer:$("#pasp_nomer").val(),pasp_adres:$("#pasp_adres").val(),pasp_ovd:$("#pasp_ovd").val(),pasp_data:$("#pasp_data").val(),nomer:$("#nomer").val(),data_create:$("#data_create").val(),sum:$("#sum").val(),avans:$("#avans").val(),reason:DOG.id?$("#reason").val():""};if(c.fio)if(c.adres)if(REGEXP_NUMERIC.test(c.nomer)&&0!=c.nomer)if(REGEXP_NUMERIC.test(c.sum)&&0!=c.sum)if(c.avans&&!REGEXP_NUMERIC.test(c.avans))b("Некорректно указан авансовый платёж","avans",a);else if(DOG.id&&!c.reason)b("Не указана причина перезаключения договора",
"reason",a);else return c;else b("Некорректно указана сумма по договору","sum",a);else b("Некорректно указан номер договора","nomer",a);else b("Не указан адрес","adres",a);else b("Не указано Фио клиента","fio",a);return!1}function b(a,b,g){c.bottom.vkHint({msg:'<span class="red">'+a+"</span>",top:g?-86:-47,left:g?141:110,indent:50,show:1,remove:1});b&&$("#"+b).focus()}var c=_dialog({width:426,top:10,head:(DOG.id?"Перез":"З")+"аключение договора",content:'<table class="zayav-dogovor"><tr><td colspan="2">'+
(DOG.id?'<div class="i per">При <b>перезаключении договора</b> удаляются сумма старого договора и авансовый платёж. Применятся данные нового договора. Также будет обновлён баланс клиента.</div>':"")+'<tr><td class="label r">Фио клиента:<td><input type="text" id="fio" value="'+DOG.fio+'" /><tr><td class="label r">Адрес:<td><input type="text" id="adres" value="'+DOG.adres+'" /><tr><td class="label r">Паспорт:<td>Серия:<input type="text" id="pasp_seria" maxlength="8" value="'+DOG.pasp_seria+'" />Номер:<input type="text" id="pasp_nomer" maxlength="10" value="'+
DOG.pasp_nomer+'" /><tr><td><td><span class="l">Прописка:</span><input type="text" id="pasp_adres" maxlength="100" value="'+DOG.pasp_adres+'" /><tr><td><td><span class="l">Кем выдан:</span><input type="text" id="pasp_ovd" maxlength="100" value="'+DOG.pasp_ovd+'" /><tr><td><td><span class="l">Когда выдан:</span><input type="text" id="pasp_data" maxlength="100" value="'+DOG.pasp_data+'" /><tr><td class="label r">Номер договора:<td><input type="text" id="nomer" maxlength="6" value="'+DOG.nomer+'" /><tr><td class="label r">Дата заключения:<td><input type="hidden" id="data_create" value="'+
(DOG.data_create?DOG.data_create:"")+'" /><tr><td class="label r">Сумма по договору:<td><input type="text" id="sum" class="money" maxlength="6" value="'+(DOG.sum?DOG.sum:"")+'" /> руб.<tr><td class="label r">Авансовый платёж:<td><input type="text" id="avans" class="money" maxlength="6" value="'+(DOG.avans?DOG.avans:"")+'" /> руб. <span class="prim">(не обязательно)</span>'+(DOG.id?'<tr><td class="label" colspan="2">Причина перезаключения договора:<textarea id="reason"></textarea>':"")+'<tr><td colspan="2"><div class="i"><h1>Внимание!</h1>Внимательно проверьте правильность всех введённых данных. После нажатия кнопки "Заключить договор" операцию отменить будет невозможно.<br /><b>Сумма по договору</b> является окончательной суммой и при заключении договора на эту сумму будет изменён баланс клиента в минус.<br /><b>Авансовый платёж</b> указывать не обязательно. При указании авансового платёжа автоматически будет внесён платёж на данную заявку.</div><tr><td colspan="2"><a id="preview">Предварительный просмотр</a><form action="'+
AJAX_MAIN+'" method="post" id="preview-form" target="_blank"></form></table>',butSubmit:(DOG.id?"Перез":"З")+"аключить договор",submit:function(){var d=a();d&&(d.op="dogovor_create",c.process(),$.post(AJAX_MAIN,d,function(a){a.success?(c.close(),_msg("Договор заключен."),document.location.reload()):(c.abort(),b(a.text))},"json"))}});$("#data_create")._calendar({lost:1});$("#preview").click(function(){var b=a("preview");if(b){b.op="dogovor_preview";var c="",g;for(g in b)c+='<input type="hidden" name="'+
g+'" value="'+b[g]+'">';$("#preview-form").html(c).submit()}});$("#reason").autosize()},setFilter=function(){return{find:$.trim($("#find input").val())}},setupRulesSet=function(a,b){$.post(AJAX_MAIN,{op:"setup_rules_set",viewer_id:RULES_VIEWER_ID,value:b,action:a},function(){},"json")};
$.fn.clientSel=function(a){function b(b){$.post(AJAX_MAIN,{op:"client_sel",val:b||"",client_id:a.client_id},function(b){b.success&&(d.spisok(b.spisok),0<a.client_id&&(d.val(a.client_id),a.client_id=0))},"json")}var c=$(this);a=$.extend({width:240,add:null,client_id:c.val()||0,func:function(){}},a);a.add&&(a.add=function(){clientAdd(function(a){d.add(a).val(a.uid)})});var d=c.vkSel({width:a.width,title0:"Начните вводить данные клиента...",spisok:[],ro:0,nofind:"Клиентов не найдено",func:a.func,funcAdd:a.add,
funcKeyup:b}).o;d.process();b();c.o=d;return c};
$.fn.productList=function(a){function b(a){var b=e+g,d=b+"id",f=b+"subid",h=b+"count";l.before('<table id="ptab'+g+'" class="ptab" val="'+g+'"><tr><td class="td"><input type="hidden" id="'+d+'" value="'+(a[0]||0)+'" /><input type="hidden" id="'+f+'" value="'+(a[1]||0)+'" /><td class="td"><input type="text" id="'+h+'" value="'+(a[2]||"")+'" class="count" maxlength="3" /> шт.'+(1<g?'<div class="img_del"></div>':"")+"</table>");var k=$("#ptab"+g);k.find(".img_del").click(function(){k.remove()});$("#"+
d)._select({width:119,title0:"Не указано",spisok:PRODUCT_SPISOK,func:function(a){$("#"+f)._select("remove").val(0);0<a&&PRODUCT_SUB_SPISOK[a]&&c(a,f,h);$("#"+h).val(0<a?1:"").focus()}});c(a[0]||0,f,h);g++}function c(a,b,c){0!=a&&PRODUCT_SUB_SPISOK[a]&&$("#"+b)._select({width:120,title0:"Подвид не указан",spisok:PRODUCT_SUB_SPISOK[a],func:function(){$("#"+c).focus()}})}var d=$(this),e=d.attr("id"),g=1,f;if("string"==typeof a&&"get"==a){a=d.find(".ptab");d=[];for(f=0;f<a.length;f++){var k=a.eq(f),h=
e+k.attr("val"),k=$("#"+h+"id").val(),m=$("#"+h+"subid").val(),h=$("#"+h+"count").val();if(0!=k){if(!REGEXP_NUMERIC.test(h)||0==h)return"count_error";d.push(k+":"+m+":"+h)}}return 0==d.length?!1:d.join()}d.html('<div class="_product-list"><a class="add">Добавить поле</a></div>');var l=d.find(".add");l.click(b);if("object"==typeof a)for(f=0;f<a.length;f++)b(a[f]);else b([]);return d};
$.fn.zayavRashod=function(a){function b(a){var c=d+e,g=c+"cat",f=c+"worker";n.append('<table id="ptab'+e+'" class="ptab" val="'+e+'"><tr><td><input type="hidden" id="'+g+'" value="'+(a[0]||0)+'" /><td class="tddop">'+(a[0]&&ZAYAVRASHOD_TXT_ASS[a[0]]?'<input type="text" class="zrtxt" placeholder="описание не указано" tabindex="'+(10*e-1)+'" value="'+a[1]+'" />':"")+(a[0]&&ZAYAVRASHOD_WORKER_ASS[a[0]]?'<input type="hidden" id="'+f+'" value="'+a[1]+'" />':"")+'<td class="tdsum'+(a[0]?"":" dn")+'"><input type="text" class="zrsum" maxlength="6" tabindex="'+
10*e+'" value="'+(a[2]||"")+'" />руб.</table>');var h=$("#ptab"+e),k=h.find(".tddop"),l=h.find(".zrsum");a[0]&&ZAYAVRASHOD_WORKER_ASS[a[0]]&&$("#"+f)._select({width:150,title0:"Сотрудник",spisok:WORKER_SPISOK,func:function(){l.focus()}});$("#"+g)._select({width:120,title0:"Категория",spisok:ZAYAVRASHOD_SPISOK,func:function(a){h.find(".tdsum")[(0<a?"remove":"add")+"Class"]("dn");ZAYAVRASHOD_TXT_ASS[a]?(k.html('<input type="text" class="zrtxt" placeholder="описание не указано" tabindex="'+(10*e-11)+
'" />'),k.find(".zrtxt").focus()):(ZAYAVRASHOD_WORKER_ASS[a]?(k.html('<input type="hidden" id="'+f+'" />'),$("#"+f)._select({width:150,title0:"Сотрудник",spisok:WORKER_SPISOK,func:function(){l.focus()}})):k.html(""),l.focus());l.val("");0<a&&!h.next().hasClass("ptab")&&b([])}});e++}var c=$(this),d=c.attr("id"),e=1,g;if("string"==typeof a&&"get"==a){a=c.find(".ptab");c=[];for(g=0;g<a.length;g++){var f=a.eq(g),k=d+f.attr("val"),h=$("#"+k+"cat").val();$("#"+k+"worker").val();var m=f.find(".zrsum").val(),
l="";if(0!=h){if(!REGEXP_NUMERIC.test(m)||0==m)return"sum_error";ZAYAVRASHOD_TXT_ASS[h]?l=f.find(".zrtxt").val():ZAYAVRASHOD_WORKER_ASS[h]&&(l=$("#"+k+"worker").val());c.push(h+":"+l+":"+m)}}return c.join()}c.html('<div class="_zayav-rashod"></div>');var n=c.find("._zayav-rashod");if("object"==typeof a)for(g=0;g<a.length;g++)b(a[g]);b([]);return c};
$(document).on("change","._attach input",function(){setCookie("_attached",0);for(var a=$(this);!a.hasClass("_attach");)a=a.parent();var b=a.find("form"),c=a.find(".form"),d=setInterval(function(){var e=getCookie("_attached");0<e&&(clearInterval(d),1==e?(e={op:"attach_get",type:b.find(".type").val(),zayav_id:b.find(".zayav_id").val()},$.post(AJAX_MAIN,e,function(d){c.removeClass("_busy");d.success&&(a.find(".files").html(d.files),b.html(d.form))},"json")):(c.removeClass("_busy"),c.next(".red").remove(),
c.after('<span class="red">Некорректный файл.</span>'),c.next(".red").fadeOut(4E3)))},500);c.addClass("_busy");b.submit()}).on("click","._attach .img_minidel",function(){var a=$(this),b={op:"attach_del",id:a.attr("val")};$.post(AJAX_MAIN,b,function(b){b.success&&(a.prev().remove(),a.remove())},"json")}).on("click",".oplata-add",function(){function a(){var a={op:"oplata_add",from:OPL.from,type:$("#income_id").val(),sum:$("#sum").val(),zayav_id:$("#zayav_id").val(),client_id:OPL.client_id,prim:$.trim($("#prim").val())};
0==a.type?b("Не указан вид платежа"):REGEXP_NUMERIC.test(a.sum)?0!=a.zayav_id||a.prim?(c.process(),$.post(AJAX_MAIN,a,function(a){if(a.success)switch(c.close(),_msg("Платёж успешно внесён!"),OPL.from){case "client":$("#income_spisok").html(a.html);$(".left:first").html(a.balans);break;case "zayav":$("#income_spisok").html(a.html)}else c.abort()},"json")):b("Если не выбрана заявка, необходимо указать примечание"):(b("Некорректно указана сумма."),$("#sum").focus())}function b(a){c.bottom.vkHint({msg:'<SPAN class="red">'+
a+"</SPAN>",remove:1,indent:40,show:1,top:-48,left:135})}var c=_dialog({top:60,width:440,head:"Внесение платежа",content:'<table class="oplata-add-tab"><tr><td class="label">Клиент:<td>'+OPL.client_fio+'<tr><td class="label">Заявка:<td><input type="hidden" id="zayav_id" value="'+(OPL.zayav_id?OPL.zayav_id:0)+'">'+(OPL.zayav_id?"<b>№"+OPL.zayav_id+"</b>":"")+'<tr><td class="label">Вид платежа:<td><input type="hidden" id="income_id" value="0"><a href="'+URL+'&p=setup&d=income" class="img_edit" title="Перейти к настройке видов платежей"></a><tr><td class="label">Сумма:<td><input type="text" id="sum" class="money" maxlength="7"> руб.<tr><td class="label">Примечание:<em>(не обязательно)</em><td><input type="text" id="prim"></table>',
submit:a});$("#sum").focus();$("#sum,#prim").keyEnter(a);OPL.zayav_spisok&&$("#zayav_id")._select({width:180,title0:"Не указана",spisok:OPL.zayav_spisok});$("#income_id")._select({width:180,title0:"Не указан",spisok:PRIHOD_SPISOK,func:function(a){$("#sum").focus()}})}).on("click",".oplata-del",function(){for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();if(!a.hasClass("deleting")){a.addClass("deleting");var b={op:"oplata_del",id:a.attr("val")};$.post(AJAX_MAIN,b,function(c){a.removeClass("deleting");
c.success&&(a.after('<tr class="deleted" val="'+b.id+'"><td colspan="4"><div>Платёж удалён. <a class="oplata-rest">Восстановить</a></div>'),a.addClass("dn"))},"json")}}).on("click",".oplata-rest",function(){for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();var b={op:"oplata_rest",id:a.attr("val")},c=a.find("div");c.hasClass("_busy")||(c.addClass("_busy"),$.post(AJAX_MAIN,b,function(b){c.removeClass("busy");b.success&&(a.prev().removeClass("dn"),a.remove())},"json"))}).on("click",".accrual-del",function(){for(var a=
$(this);"TR"!=a[0].tagName;)a=a.parent();if(!a.hasClass("deleting")){a.addClass("deleting");var b={op:"accrual_del",id:a.attr("val")};$.post(AJAX_MAIN,b,function(c){a.removeClass("deleting");c.success&&(a.after('<tr class="deleted" val="'+b.id+'"><td colspan="4"><div>Начисление удалено. <a class="accrual-rest">Восстановить</a></div>'),a.addClass("dn"))},"json")}}).on("click",".accrual-rest",function(){for(var a=$(this);"TR"!=a[0].tagName;)a=a.parent();var b={op:"accrual_rest",id:a.attr("val")},c=
a.find("div");c.hasClass("_busy")||(c.addClass("_busy"),$.post(AJAX_MAIN,b,function(b){c.removeClass("busy");b.success&&(a.prev().removeClass("dn"),a.remove())},"json"))}).on("click","#client .ajaxNext",function(){if(!$(this).hasClass("busy")){var a=$(this),b=clientFilter();b.op="client_next";b.page=a.attr("val");a.addClass("busy");$.post(AJAX_MAIN,b,function(b){b.success?(a.remove(),$("#client .left").append(b.spisok)):a.removeClass("busy")},"json")}}).on("click",".zayav_add",function(){_dialog({width:220,
top:60,head:"Выберите категорию заявки",content:'<div class="zayav-add all"><div class="vkButton zakaz_add"><button>Новый заказ</button></div><br /><div class="vkButton zamer_add"><button>Новый замер</button></div><br /><div class="vkButton set_add"><button>Новая установка</button></div></div>',butSubmit:""})}).on("click",".zayav_unit",function(){document.location.href=URL+"&p=zayav&d=info&id="+$(this).attr("val")}).on("click","#zayav #filter_break",function(){zFind.clear();$("#desc")._check(0);$("#status").rightLink(0);
zayavSpisokLoad()}).on("click",".zakaz_add",function(){"undefined"==typeof CLIENT&&(CLIENT={id:0,fio:"",adres:""});var a=CLIENT.adres,b=_dialog({width:550,top:30,head:"Внесение нового заказа",content:'<table class="zayav-add"><tr><td class="label">Клиент:<td><INPUT type="hidden" id="client_id" value="'+CLIENT.id+'"><b>'+CLIENT.fio+'</b><tr><td class="label topi">Изделие:<td id="product"><tr><td><td><input type="text" id="zakaz_txt" placeholder="либо укажите содержание заказа вручную.." maxlength="300"><tr><td class="label top">Заметка:\t<td><textarea id="comm"></textarea></table>',
submit:function(){var a,c={op:"zakaz_add",client_id:$("#client_id").val(),product:$("#product").productList("get"),zakaz_txt:$("#zakaz_txt").val(),comm:$("#comm").val()};0==c.client_id?a="Не выбран клиент":c.product||c.zakaz_txt?"count_error"==c.product?a="Некорректно введено количество изделий":(b.process(),$.post(AJAX_MAIN,c,function(a){a.success?(b.close(),_msg("Заявка внесена"),location.href=URL+"&p=zayav&d=info&id="+a.id):b.abort()},"json")):a="Необходимо выбрать изделие или вписать заказ вручную";
a&&b.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-48,left:171,indent:50,show:1,remove:1})}});if(0==CLIENT.id)var c=$("#client_id").clientSel({add:1,func:function(b){a=c.item(b).adres;1==$("#homeadres").val()&&$("#adres").val(a)}}).o;$("#product").productList();$("#comm").autosize()}).on("click","#zakaz_next",function(){var a=$(this);if(!a.hasClass("busy")){var b=zakazFilter();b.op="zakaz_next";b.page=a.attr("val");a.addClass("busy");$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():
a.removeClass("busy")},"json")}}).on("click",".zakaz_status",function(){$(this);var a=_dialog({width:400,top:30,head:"Изменение статуса заказа",content:'<table class="zamer-status-edit"><tr><td class="label topi">Статус заказа:<td><INPUT type="hidden" id="edit_zakaz" value="'+ZAYAV.status+'"></table>',butSubmit:"Применить",submit:function(){var b={op:"zakaz_status",zayav_id:ZAYAV.id,status:$("#edit_zakaz").val()};a.process();$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Данные изменены!"),
document.location.reload()):a.abort()},"json")}});$("#edit_zakaz")._radio({bottom:20,spisok:[{uid:1,title:"Ожидает выполнения"},{uid:2,title:"Выполнен"},{uid:3,title:"Отменён"}]})}).on("click",".zamer_table",function(){var a=_dialog({width:600,top:10,head:"Таблица замеров",load:1,butSubmit:"",butCancel:"Закрыть"}),b={op:"zamer_table_get",val:$(this).attr("val")||0};$.post(AJAX_MAIN,b,function(b){b.success?a.content.html(b.html):a.loadError()},"json")}).on("click","#zamer-table .ztu",function(){document.location.href=
URL+"&p=zayav&d=info&id="+$(this).attr("val")}).on("click","#zamer-table .mon a",function(){var a=$(this),b=a.parent(),a={op:"zamer_table_get",mon:a.attr("val")};b.hasClass("_busy")||(b.addClass("_busy"),$.post(AJAX_MAIN,a,function(a){a.success?$("#zamer-table").parent().html(a.html):b.removeClass("_busy")},"json"))}).on("click",".zamer_add",function(){function a(a){c.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-48,left:185,indent:40,show:1,remove:1})}"undefined"==typeof CLIENT&&(CLIENT=
{id:0,fio:"",adres:""});var b=CLIENT.adres,c=_dialog({width:550,top:30,head:"Внесение новой заявки на замер",content:'<table class="zayav-add"><tr><td class="label">Клиент:<td><INPUT type="hidden" id="client_id" value="'+CLIENT.id+'"><b>'+CLIENT.fio+'</b><tr><td class="label topi">Изделие:<td id="product"><tr><td class="label">Адрес проведения замера:<td><INPUT type="text" id="adres" maxlength="100" /><INPUT type="hidden" id="homeadres" /><tr><td class="label">Дата и время замера:<td class="zayav-zamer-dtime"><tr><td class="label">Длительность замера:<td><INPUT TYPE="hidden" id="zamer_duration" value="30" /><tr><td class="label top">Заметка:\t<td><textarea id="comm"></textarea></table>',
submit:function(){var b={op:"zamer_add",client_id:$("#client_id").val(),product:$("#product").productList("get"),adres:$("#adres").val(),zamer_day:$("#zamer_day").val(),zamer_hour:$("#zamer_hour").val(),zamer_min:$("#zamer_min").val(),zamer_duration:$("#zamer_duration").val(),comm:$("#comm").val()};0==b.client_id?a("Не выбран клиент"):b.product?"count_error"==b.product?a("Некорректно введено количество изделий"):b.adres?(c.process(),$.post(AJAX_MAIN,b,function(b){b.success?(c.close(),_msg("Заявка внесена"),
location.href=URL+"&p=zayav&d=info&id="+b.id):(c.abort(),a(b.text))},"json")):a("Не указан адрес"):a("Не указано изделие")}});if(0==CLIENT.id)var d=$("#client_id").clientSel({add:1,func:function(a){b=d.item(a).adres;1==$("#homeadres").val()&&$("#adres").val(b)}}).o;$("#product").productList();$("#homeadres")._check({func:function(){$("#adres").val(b)}});$("#homeadres_check").vkHint({msg:"Совпадает с адресом проживания",top:-75,left:193,indent:60,delayShow:700});zayavZamerDtime({});$("#comm").autosize()}).on("click",
".zamer_status",function(){function a(a){e.content.html('<table class="zamer-status-edit"><tr><td class="label topi">Результат замера:<td><INPUT type="hidden" id="edit_zamer" value="-1"><tr class="tr_data dn"><td class="label">Новое время:<td class="zayav-zamer-dtime"><tr class="tr_data dn"><td class="label">Длительность:   <td><INPUT TYPE="hidden" id="zamer_duration" value="'+a.dur+'" /><a class="zamer_table" val="'+d+'">Таблица замеров</a><tr class="tr_prim dn"><td class="label top">Комментарий:<td><textarea id="prim"></textarea></table>');
$("#edit_zamer")._radio({bottom:20,spisok:[{uid:1,title:"Указать другое время<span>Замер будет перенесён на другое время.</span>"},{uid:2,title:"Выполнен<span>Замер выполнен успешно. Заявка будет переведена на заключение договора.</span>"},{uid:3,title:"Отмена<span>Отмена заявки по какой-либо причине.</span>"}],func:function(a){$(".tr_data")[(1==a?"remove":"add")+"Class"]("dn");$(".tr_prim").removeClass("dn")}});zayavZamerDtime(a)}function b(a){$(this).vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",
top:-58,left:-5,indent:40,remove:1,show:1})}var c=$(this),d="undefined"!=typeof ZAYAV?ZAYAV.id:c.attr("val"),e=_dialog({width:400,top:30,head:"Изменение статуса замера",load:1,butSubmit:"Применить",submit:function(){var a={op:"zamer_status",zayav_id:d,status:$("#edit_zamer").val(),zamer_day:$("#zamer_day").val(),zamer_hour:$("#zamer_hour").val(),zamer_min:$("#zamer_min").val(),zamer_duration:$("#zamer_duration").val(),prim:$("#prim").val()};-1==a.status?b("Выберите вариант."):(e.process(),$.post(AJAX_MAIN,
a,function(a){a.success?(e.close(),_msg("Данные изменены!"),document.location.reload()):(e.abort(),b(a.text))},"json"))}});"undefined"==typeof ZAYAV?$.post(AJAX_MAIN,{op:"zamer_info_get",zayav_id:d},function(b){b.success?a(b):e.loadError()},"json"):a(ZAYAV)}).on("click","#zamer_next",function(){var a=$(this);if(!a.hasClass("busy")){var b=zamerFilter();b.op="zamer_next";b.page=a.attr("val");a.addClass("busy");$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},
"json")}}).on("click","#dog_next",function(){var a=$(this);if(!a.hasClass("busy")){var b=dogovorFilter();b.op="dog_next";b.page=a.attr("val");a.addClass("busy");$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json")}}).on("click",".set_add",function(){"undefined"==typeof CLIENT&&(CLIENT={id:0,fio:"",adres:""});var a=CLIENT.adres,b=_dialog({width:550,top:30,head:"Внесение новой заявки на установку",content:'<table class="zayav-add"><tr><td class="label">Клиент:<td><INPUT type="hidden" id="client_id" value="'+
CLIENT.id+'"><b>'+CLIENT.fio+'</b><tr><td class="label topi">Изделие:<td id="product"><tr><td class="label">Адрес установки:<td><INPUT type="text" id="adres" maxlength="100" /><INPUT type="hidden" id="homeadres" /><tr><td class="label top">Заметка:\t<td><textarea id="comm"></textarea></table>',submit:function(){var a,c={op:"set_add",client_id:$("#client_id").val(),product:$("#product").productList("get"),adres:$("#adres").val(),comm:$("#comm").val()};0==c.client_id?a="Не выбран клиент":c.product?
"count_error"==c.product?a="Некорректно введено количество изделий":c.adres?(b.process(),$.post(AJAX_MAIN,c,function(a){a.success?(b.close(),_msg("Заявка внесена"),location.href=URL+"&p=zayav&d=info&id="+a.id):b.abort()},"json")):a="Не указан адрес":a="Не указано изделие";a&&b.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-48,left:171,indent:50,show:1,remove:1})}});if(0==CLIENT.id)var c=$("#client_id").clientSel({add:1,func:function(b){a=c.item(b).adres;1==$("#homeadres").val()&&$("#adres").val(a)}}).o;
$("#product").productList();$("#homeadres")._check({func:function(){$("#adres").val(a)}});$("#homeadres_check").vkHint({msg:"Совпадает с адресом проживания",top:-75,left:193,indent:60,delayShow:700});$("#comm").autosize()}).on("click",".set_status",function(){$(this);var a=_dialog({width:400,top:30,head:"Изменение статуса установки",content:'<table class="zamer-status-edit"><tr><td class="label topi">Статус установки:<td><INPUT type="hidden" id="edit_set" value="'+ZAYAV.status+'"></table>',butSubmit:"Применить",
submit:function(){var b={op:"set_status",zayav_id:ZAYAV.id,status:$("#edit_set").val()};a.process();$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Данные изменены!"),document.location.reload()):a.abort()},"json")}});$("#edit_set")._radio({bottom:20,spisok:[{uid:1,title:"Ожидает выполнения"},{uid:2,title:"Выполнена"},{uid:3,title:"Отменена"}]})}).on("click","#set_next",function(){var a=$(this);if(!a.hasClass("busy")){var b=setFilter();b.op="set_next";b.page=a.attr("val");a.addClass("busy");
$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json")}}).on("click",".remind_calendar .on",function(){var a=$(this),b=a.parent().parent(),a={op:"remind_day",day:a.attr("val")};b.hasClass("busy")||(b.addClass("busy"),$.post(AJAX_MAIN,a,function(a){a.success&&($("#remind .left").html(a.html),$("#remind").removeClass("y"));b.removeClass("busy")},"json"))}).on("click","#remind .fmon",function(){var a=$(this);$(".right .remind_calendar").html(a.next().html());
$(".goyear span").html(a.html());$("#remind").removeClass("y")}).on("click","#history_next",function(){if(!$(this).hasClass("busy")){var a=$(this),b={op:"history_next",page:$(this).attr("val")};a.addClass("busy");$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json")}}).on("click",".invoice_set",function(){function a(){var a={op:"invoice_set",invoice_id:b.attr("val"),sum:$("#sum").val()};REGEXP_NUMERIC.test(a.sum)?(c.process(),$.post(AJAX_MAIN,a,function(e){e.success?
(b.parent().html("<b>"+a.sum+"</b> руб."),c.close(),_msg("Баланс установлен.")):c.abort()},"json")):(c.bottom.vkHint({msg:'<SPAN class="red">Некорректно указана сумма</SPAN>',remove:1,indent:40,show:1,top:-48,left:62}),$("#sum").focus())}var b=$(this),c=_dialog({width:300,top:60,head:"Установка начального баланса счёта",content:'<table style="border-spacing:10px"><tr><td class="label">Сумма:<td><INPUT type="text" class="money" id="sum" maxlength="7"> руб.</table>',butSubmit:"Установить",submit:a});
$("#sum").focus().keyEnter(a)}).on("click",".income_mon",function(){function a(){var a={op:"invoice_set",invoice_id:b.attr("val"),sum:$("#sum").val()};REGEXP_NUMERIC.test(a.sum)?(c.process(),$.post(AJAX_MAIN,a,function(e){e.success?(b.parent().html("<b>"+a.sum+"</b> руб."),c.close(),_msg("Баланс установлен.")):c.abort()},"json")):(c.bottom.vkHint({msg:'<SPAN class="red">Некорректно указана сумма</SPAN>',remove:1,indent:40,show:1,top:-48,left:62}),$("#sum").focus())}var b=$(this),c=_dialog({width:300,
top:60,head:"Установка начального баланса счёта",content:'<table style="border-spacing:10px"><tr><td class="label">Сумма:<td><INPUT type="text" class="money" id="sum" maxlength="7"> руб.</table>',butSubmit:"Установить",submit:a});$("#sum").focus().keyEnter(a)}).on("click","#money_next",function(){if(!$(this).hasClass("busy")){var a=$(this),b={op:"money_next",page:$(this).attr("val"),limit:$("#money_limit").val(),client_id:$("#money_client_id").val(),zayav_id:$("#money_zayav_id").val()};a.addClass("busy");
$.post(AJAX_MAIN,b,function(b){b.success?a.after(b.html).remove():a.removeClass("busy")},"json")}}).on("click","#setup_worker .add",function(){function a(){if(!e.hasClass("busy")){d=0;$(".res").remove();var a={user_ids:$.trim($("#viewer_id").val()),fields:"photo_50",v:5.2};a.user_ids&&(/vk.com/.test(a.user_ids)&&(a.user_ids=a.user_ids.split("vk.com/")[1]),/\?/.test(a.user_ids)&&(a.user_ids=a.user_ids.split("?")[0]),/#/.test(a.user_ids)&&(a.user_ids=a.user_ids.split("#")[0]),e.addClass("busy"),VK.api("users.get",
a,function(a){e.removeClass("busy");a.response&&(a=a.response[0],e.after('<table class="res"><tr><td class="photo"><img src='+a.photo_50+'><td class="name">'+a.first_name+" "+a.last_name+"</table>"),d=a.id)}))}}function b(a,b){c.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",remove:1,indent:40,show:1,top:b,left:90})}var c=_dialog({top:50,width:350,head:"Добавление нового сотрудника",content:'<div id="setup_worker_add"><h1>Укажите адрес страницы пользователя или его<br />ID ВКонтакте:</h1><h2>Формат адреса может быть следующих видов:<br /><u>http://vk.com/id12345</u>, <u>http://vk.com/durov</u>.<br />Либо используйте ID пользователя: <u>id12345</u>, <u>durov</u>, <u>12345</u>.</h2><input type="text" id="viewer_id" /><div class="vkButton"><button>Найти</button></div><a class="manual">Или заполните данные вручную..</a><table class="manual_tab"><tr><td class="label">Имя:<td><input type="text" id="first_name" /><tr><td class="label">Фамилия:<td><input type="text" id="last_name" /><tr><td class="label">Пол:<td><input type="hidden" id="sex" value="0" /><tr><td class="label">Должность:<td><input type="text" id="post" /></table></div>',
butSubmit:"Добавить",submit:function(){var a={op:"setup_worker_add",viewer_id:d,first_name:$("#first_name").val(),last_name:$("#last_name").val(),sex:$("#sex").val(),post:$("#post").val()};a.viewer_id||a.first_name||a.last_name?a.first_name&&a.last_name&&0==a.sex?b("Не указан пол",-47):(c.process(),$.post(AJAX_MAIN,a,function(a){a.success?(c.close(),_msg("Новый сотрудник успешно добавлен."),$("#spisok").html(a.html)):(c.abort(),b(a.text,-60))},"json")):b("Произведите поиск пользователя<br>или укажите вручную имя и фамилию",
-60)}}),d=0,e=$("#viewer_id").focus().keyEnter(a).next();e.click(a);$(".manual").click(function(){$(this).hide().next().show();$(".res").remove();d=0;$("#viewer_id").val("");$("#first_name").focus()});$("#sex")._radio({spisok:[{uid:2,title:"М"},{uid:1,title:"Ж"}]})}).on("click","#setup_worker .img_del",function(){for(var a=$(this);!a.hasClass("unit");)a=a.parent();var b=_dialog({top:110,width:250,head:"Удаление сотрудника",content:"<center>Подтвердите удаление сотрудника.</center>",butSubmit:"Удалить",
submit:function(){var c={op:"setup_worker_del",viewer_id:a.attr("val")};b.process();$.post(AJAX_MAIN,c,function(a){a.success?(b.close(),_msg("Сотрудник удален."),$("#spisok").html(a.html)):b.abort()},"json")}})}).on("click","#setup_product .add",function(){function a(){var a={op:"setup_product_add",name:$("#name").val()};a.name?(b.process(),$.post(AJAX_MAIN,a,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Внесено!")):b.abort()},"json")):(b.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",
top:-47,left:99,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var b=_dialog({top:60,width:390,head:"Добавление нового наименования изделия",content:'<table style="border-spacing:10px"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="100" style="width:250px" /></table>',submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_product .img_edit",function(){function a(){var a={op:"setup_product_edit",id:c,name:$("#name").val()};a.name?(e.process(),$.post(AJAX_MAIN,
a,function(a){a.success?($(".spisok").html(a.html),e.close(),_msg("Сохранено!")):e.abort()},"json")):(e.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:99,indent:50,show:1,remove:1}),$("#name").focus())}for(var b=$(this);"TR"!=b[0].tagName;)b=b.parent();var c=b.attr("val"),d=b.find(".name a");b.find(".dog").html();var b='<table style="border-spacing:10px"><tr><td class="label">Наименование:<td><input id="name" type="text" maxlength="100" style="width:250px" value="'+
d.html()+'" /></table>',e=_dialog({top:60,width:390,head:"Редактирование наименования изделия",content:b,butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_product .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление изделия",content:"<center><b>Подтвердите удаление изделия.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=a[0].tagName;)a=a.parent();var c={op:"setup_product_del",id:a.attr("val")};b.process();$.post(AJAX_MAIN,
c,function(c){c.success?(a.remove(),b.close(),_msg("Удалено!")):b.abort()},"json")}})}).on("click","#setup_product_sub .add",function(){function a(){var a={op:"setup_product_sub_add",product_id:PRODUCT_ID,name:$("#name").val()};a.name?(b.process(),$.post(AJAX_MAIN,a,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Внесено!")):b.abort()},"json")):(b.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:99,indent:50,show:1,remove:1}),$("#name").focus())}$(this);
var b=_dialog({top:60,width:390,head:"Добавление нового подвида изделия",content:'<table style="border-spacing:10px"><tr><td class="label">Наименование:<td><input id="name" type="text" maxlength="100" style="width:250px" /></table>',submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_product_sub .img_edit",function(){function a(){var a={op:"setup_product_sub_edit",id:b.attr("val"),name:$("#name").val()};a.name?(e.process(),$.post(AJAX_MAIN,a,function(b){b.success?(c.html(a.name),e.close(),
_msg("Сохранено!")):e.abort()},"json")):(e.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:99,indent:50,show:1,remove:1}),$("#name").focus())}for(var b=$(this);"TR"!=b[0].tagName;)b=b.parent();var c=b.find(".name"),d='<table style="border-spacing:10px"><tr><td class="label">Наименование:<td><input id="name" type="text" maxlength="100" style="width:250px" value="'+c.html()+'" /></table>',e=_dialog({top:60,width:390,head:"Редактирование подвида изделия",content:d,butSubmit:"Сохранить",
submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_product_sub .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление подвида",content:"<center><b>Подтвердите удаление подвида изделия.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=a[0].tagName;)a=a.parent();var c={op:"setup_product_sub_del",id:a.attr("val")};b.process();$.post(AJAX_MAIN,c,function(c){c.success?(a.remove(),b.close(),_msg("Удалено!")):b.abort()},"json")}})}).on("click","#setup_invoice .add",
function(){function a(){var a={op:"setup_invoice_add",name:$("#name").val(),about:$("#about").val(),types:$("#types").val()};a.name?(c.process(),$.post(AJAX_MAIN,a,function(a){a.success?($(".spisok").html(a.html),c.close(),_msg("Внесено!")):(c.abort(),b(a.text))},"json")):(b("Не указано наименование"),$("#name").focus())}function b(a){c.bottom.vkHint({msg:"<SPAN class=red>"+a+"</SPAN>",top:-47,left:100,indent:50,show:1,remove:1})}$(this);var c=_dialog({top:60,width:400,head:"Добавление нового счёта",
content:'<table class="setup-tab"><tr><td class="label">Наименование:<td><input id="name" type="text" maxlength="50" /><tr><td class="label topi">Описание:<td><textarea id="about"></textarea><tr><td class="label topi">Виды платежей:<td><input type="hidden" id="types" /></table>',submit:a});$("#name").focus().keyEnter(a);$("#types")._select({width:218,multiselect:1,spisok:PRIHOD_SPISOK})}).on("click","#setup_invoice .img_edit",function(){function a(){var a={op:"setup_invoice_edit",id:d,name:$("#name").val(),
about:$("#about").val(),types:$("#types").val()};a.name?(f.process(),$.post(AJAX_MAIN,a,function(a){a.success?($(".spisok").html(a.html),f.close(),_msg("Сохранено!")):(f.abort(),b(a.text))},"json")):(b("Не указано наименование"),$("#name").focus())}function b(a){f.bottom.vkHint({msg:"<SPAN class=red>"+a+"</SPAN>",top:-47,left:100,indent:50,show:1,remove:1})}for(var c=$(this);"TR"!=c[0].tagName;)c=c.parent();var d=c.attr("val"),e=c.find(".name div").html(),g=c.find(".name pre").html(),c=c.find(".type_id").val(),
f=_dialog({top:60,width:400,head:"Редактирование данный счёта",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="100" value="'+e+'" /><tr><td class="label r top">Описание:<td><textarea id="about">'+g+'</textarea><tr><td class="label topi">Виды платежей:<td><input type="hidden" id="types" value="'+c+'" /></table>',butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a);$("#types")._select({width:218,multiselect:1,spisok:PRIHOD_SPISOK})}).on("click",
"#setup_invoice .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление счёта",content:"<center><b>Подтвердите удаление счёта.</b></center>",butSubmit:"Удалить",submit:function(){for(;"TR"!=a[0].tagName;)a=a.parent();var c={op:"setup_invoice_del",id:a.attr("val")};b.process();$.post(AJAX_MAIN,c,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Удалено!")):b.abort()},"json")}})}).on("click","#setup_income .add",function(){function a(){var a={op:"setup_income_add",
name:$("#name").val()};a.name?(b.process(),$.post(AJAX_MAIN,a,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Внесено!"),sortable()):b.abort()},"json")):(b.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}$(this);var b=_dialog({top:60,width:440,head:"Добавление нового вида платежа",content:'<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="100" /></table>',
submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_income .img_edit",function(){function a(){var a={op:"setup_income_edit",id:c,name:$("#name").val()};a.name?(d.process(),$.post(AJAX_MAIN,a,function(a){a.success?($(".spisok").html(a.html),d.close(),_msg("Сохранено!"),sortable()):d.abort()},"json")):(d.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}for(var b=$(this);"DD"!=b[0].tagName;)b=b.parent();var c=
b.attr("val"),b='<table class="setup-tab"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="100" value="'+b.find(".name").html()+'" /></table>',d=_dialog({top:60,width:440,head:"Редактирование вида платежа",content:b,butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a)}).on("click","#setup_income .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление вида платежа",content:"<center><b>Подтвердите удаление вида платежа.</b></center>",
butSubmit:"Удалить",submit:function(){for(;"DD"!=a[0].tagName;)a=a.parent();var c={op:"setup_income_del",id:a.attr("val")};b.process();$.post(AJAX_MAIN,c,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Удалено!"),sortable()):b.abort()},"json")}})}).on("click","#setup_zayavrashod .add",function(){function a(){var a={op:"setup_zayavrashod_add",name:$("#name").val(),show_txt:$("#show_txt").val(),show_worker:$("#show_worker").val()};a.name?(c.process(),$.post(AJAX_MAIN,a,function(a){a.success?
($(".spisok").html(a.html),c.close(),_msg("Внесено!"),sortable()):c.abort()},"json")):(c.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}function b(a,b){1==a&&("show_txt"==b?$("#show_worker")._check(0):$("#show_txt")._check(0))}$(this);var c=_dialog({top:60,width:440,head:"Добавление новой категории расхода заявки",content:'<table style="border-spacing:10px"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="50" style="width:210px" /><tr><td class="label r">Текстовое поле:<td><input id="show_txt" type="hidden" /><tr><td class="label r">Список сотрудников:<td><input id="show_worker" type="hidden" /></table>',
submit:a});$("#name").focus().keyEnter(a);$("#show_txt")._check({func:b});$("#show_worker")._check({func:b})}).on("click","#setup_zayavrashod .img_edit",function(){function a(){var a={op:"setup_zayavrashod_edit",id:d,name:$("#name").val(),show_txt:$("#show_txt").val(),show_worker:$("#show_worker").val()};a.name?(f.process(),$.post(AJAX_MAIN,a,function(a){a.success?($(".spisok").html(a.html),f.close(),_msg("Сохранено!"),sortable()):f.abort()},"json")):(f.bottom.vkHint({msg:"<SPAN class=red>Не указано наименование</SPAN>",
top:-47,left:131,indent:50,show:1,remove:1}),$("#name").focus())}function b(a,b){1==a&&("show_txt"==b?$("#show_worker")._check(0):$("#show_txt")._check(0))}for(var c=$(this);"DD"!=c[0].tagName;)c=c.parent();var d=c.attr("val"),e=c.find(".name").html(),g=c.find(".txt").html()?1:0,c=c.find(".worker").html()?1:0,f=_dialog({top:60,width:440,head:"Редактирование категории расхода заявки",content:'<table style="border-spacing:10px"><tr><td class="label r">Наименование:<td><input id="name" type="text" maxlength="50" style="width:210px" value="'+
e+'" /><tr><td class="label r">Текстовое поле:<td><input id="show_txt" type="hidden" value="'+g+'" /><tr><td class="label r">Список сотрудников:<td><input id="show_worker" type="hidden" value="'+c+'" /></table>',butSubmit:"Сохранить",submit:a});$("#name").focus().keyEnter(a);$("#show_txt")._check({func:b});$("#show_worker")._check({func:b})}).on("click","#setup_zayavrashod .img_del",function(){var a=$(this),b=_dialog({top:90,width:300,head:"Удаление категории расхода заявки",content:"<center><b>Подтвердите удаление<br />категории расхода заявки.</b></center>",
butSubmit:"Удалить",submit:function(){for(;"DD"!=a[0].tagName;)a=a.parent();var c={op:"setup_zayavrashod_del",id:a.attr("val")};b.process();$.post(AJAX_MAIN,c,function(a){a.success?($(".spisok").html(a.html),b.close(),_msg("Удалено!"),sortable()):b.abort()},"json")}})}).ready(function(){0<$("#client").length&&(window.cFind=$("#find")._search({width:602,focus:1,enter:1,txt:"Начните вводить данные клиента",func:clientSpisokLoad}),$("#buttonCreate").vkHint({msg:'<B>Внесение нового клиента в базу.</B><br /><br />После внесения Вы попадаете на страницу с информацией о клиенте для дальнейших действий.<br /><br />Клиентов также можно добавлять при <A href="'+
URL+'&p=zayav&d=add&back=client">создании новой заявки</A>.',ugol:"right",width:215,top:-38,left:-250,indent:40,delayShow:1E3,correct:0}).click(clientAdd),$("#dolg")._check(clientSpisokLoad),$("#dolg_check").vkHint({msg:"<b>Список должников.</b><br /><br />Выводятся клиенты, у которых баланс менее 0. Также в результате отображается общая сумма долга.",ugol:"right",width:150,top:-6,left:-185,indent:20,delayShow:1E3,correct:0}));0<$("#clientInfo").length&&($("#dopLinks .link").click(function(){$("#dopLinks .link").removeClass("sel");
$(this).addClass("sel");var a=$(this).attr("val");$(".res").css("display","zayav"==a?"block":"none");$("#zayav_filter").css("display","zayav"==a?"block":"none");$("#zayav_spisok").css("display","zayav"==a?"block":"none");$("#income_spisok").css("display","money"==a?"block":"none");$("#remind_spisok").css("display","remind"==a?"block":"none");$("#comments").css("display","comm"==a?"block":"none");$("#histories").css("display","hist"==a?"block":"none")}),$(".cedit").click(function(){function a(){var a=
{op:"client_edit",client_id:CLIENT.id,fio:$("#fio").val(),telefon:$("#telefon").val(),adres:$("#adres").val(),pasp_seria:$("#pasp_seria").val(),pasp_nomer:$("#pasp_nomer").val(),pasp_adres:$("#pasp_adres").val(),pasp_ovd:$("#pasp_ovd").val(),pasp_data:$("#pasp_data").val()};a.fio?(b.process(),$.post(AJAX_MAIN,a,function(a){a.success?(CLIENT=a,$(".left:first").html(a.html),b.close(),_msg("Данные клиента изменены.")):b.abort()},"json")):(b.bottom.vkHint({msg:'<span class="red">Не указано имя клиента.</span>',
top:-47,left:100,indent:50,show:1,remove:1}),$("#fio").focus())}var b=_dialog({head:"Редактирование данных клиента",top:30,width:380,content:'<table class="client-add"><tr><td class="label">Имя:<td><input type="text" id="fio" maxlength="100" value="'+CLIENT.fio+'"><tr><td class="label">Телефон:<td><input type="text" id="telefon" maxlength="100" value="'+CLIENT.telefon+'"><tr><td class="label">Адрес:<td><input type="text" id="adres" maxlength="100" value="'+CLIENT.adres+'"><tr><td><td><b>Паспортные данные:</b><tr><td class="label">Серия:<td><input type="text" id="pasp_seria" maxlength="8" value="'+
CLIENT.pasp_seria+'"><span class="label">Номер:</span><input type="text" id="pasp_nomer" maxlength="10" value="'+CLIENT.pasp_nomer+'"><tr><td class="label">Прописка:<td><input type="text" id="pasp_adres" maxlength="100" value="'+CLIENT.pasp_adres+'"><tr><td class="label">Кем выдан:<td><input type="text" id="pasp_ovd" maxlength="100" value="'+CLIENT.pasp_ovd+'"><tr><td class="label">Когда выдан:<td><input type="text" id="pasp_data" maxlength="100" value="'+CLIENT.pasp_data+'"></table>',butSubmit:"Сохранить",
submit:a});$("#fio,#telefon,#adres,#pasp_seria,#pasp_nomer,#pasp_adres,#pasp_ovd,#pasp_data").keyEnter(a)}),$(".cdel").click(function(){var a=_dialog({top:90,width:300,head:"Удаление клиента",content:"<center>Внимание!<br />Будут удалены все данные о клиенте,<br />его заявки, платежи и задачи.<br /><b>Подтвердите удаление.</b></center>",butSubmit:"Удалить",submit:function(){var b={op:"client_del",id:CLIENT.id};a.process();$.post(AJAX_MAIN,b,function(b){b.success?(a.close(),_msg("Клиент удален!"),
location.href=URL+"&p=client"):a.abort()},"json")}})}),$("#status").rightLink(clientZayavSpisokLoad));0<$("#zayav").length&&(window.zFind=$("#find")._search({width:153,focus:1,txt:"Быстрый поиск...",enter:1,func:zayavSpisokLoad}));0<$(".zayav-info").length&&($(".zinfo").click(function(){$(this).parent().find(".sel").removeClass("sel");$(this).addClass("sel");$(".zayav-info").removeClass("h")}),$(".hist").click(function(){$(this).parent().find(".sel").removeClass("sel");$(this).addClass("sel");$(".zayav-info").addClass("h")}),
$(".dogovor_create").click(dogovorCreate),$(".dogovor_no_require").click(function(){$.post(AJAX_MAIN,{op:"dogovor_no_require",zayav_id:ZAYAV.id},function(a){a.success&&document.location.reload()},"json")}),$("#dogovor_action").linkMenu({head:"Не заключен",spisok:[{uid:1,title:"Заключить договор"},{uid:2,title:'Перевести заявку в категорию "Требуется договор"'}],func:function(a){1==a&&dogovorCreate();2==a&&$.post(AJAX_MAIN,{op:"dogovor_require",zayav_id:ZAYAV.id},function(a){a.success&&document.location.reload()},
"json")},nosel:1}),$(".reneg").click(dogovorCreate),$(".zakaz_edit").click(function(){function a(){var a,d={op:"zakaz_edit",zayav_id:ZAYAV.id,product:$("#product").productList("get"),zakaz_txt:$("#zakaz_txt").val(),nomer_vg:$("#nomer_vg").val(),nomer_g:$("#nomer_g").val(),nomer_d:$("#nomer_d").val()};d.product||d.zakaz_txt?"count_error"==d.product?a="Некорректно введено количество изделий":(b.process(),$.post(AJAX_MAIN,d,function(a){a.success?(b.close(),_msg("Данные изменены!"),document.location.reload()):
b.abort()},"json")):a="Необходимо выбрать изделие или вписать заказ вручную";a&&b.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-47,left:161,indent:40,show:1,remove:1})}var b=_dialog({width:500,top:30,head:"Заказ №"+ZAYAV.id+" - Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label">Клиент:      <td>'+ZAYAV.client_fio+'<tr><td class="label topi">Изделие:<td id="product"><tr><td><td><input type="text" id="zakaz_txt" placeholder="либо укажите содержание заказа вручную.." maxlength="300" value="'+
ZAYAV.zakaz_txt+'"><tr><td class="label">Номер ВГ:\t   <td><INPUT type="text" id="nomer_vg" maxlength="30" value="'+ZAYAV.nomer_vg+'" /><tr><td class="label">Номер Ж: \t   <td><INPUT type="text" id="nomer_g" maxlength="30" value="'+ZAYAV.nomer_g+'" /><tr><td class="label">Номер Д: \t   <td><INPUT type="text" id="nomer_d" maxlength="30" value="'+ZAYAV.nomer_d+'" /></table>',butSubmit:"Сохранить",submit:a});$("#product").productList(ZAYAV.product);$("#zakaz_txt").keyEnter(a)}),$(".zamer_edit").click(function(){function a(a){b.bottom.vkHint({msg:'<SPAN class="red">'+
a+"</SPAN>",top:-47,left:161,indent:40,show:1,remove:1})}var b=_dialog({width:500,top:30,head:"Замер №"+ZAYAV.id+" - Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label">Клиент:        <td>'+ZAYAV.client_fio+'<tr><td class="label top">Изделие:\t<td id="product"><tr><td class="label">Адрес замера:  <td><INPUT type="text" id="adres" maxlength="100" value="'+ZAYAV.adres+'" /><tr><td class="label">Дата и время замера:<td class="zayav-zamer-dtime"><tr><td class="label">Длительность замера:<td><INPUT TYPE="hidden" id="zamer_duration" value="'+
ZAYAV.dur+'" /><a class="zamer_table" val="'+ZAYAV.id+'">Таблица замеров</a></table>',butSubmit:"Сохранить",submit:function(){var c={op:"zamer_edit",zayav_id:ZAYAV.id,product:$("#product").productList("get"),adres:$("#adres").val(),zamer_day:$("#zamer_day").val(),zamer_hour:$("#zamer_hour").val(),zamer_min:$("#zamer_min").val(),zamer_duration:$("#zamer_duration").val()};c.product?"count_error"==c.product?a("Некорректно введено количество изделий"):c.adres?(b.process(),$.post(AJAX_MAIN,c,function(c){c.success?
(b.close(),_msg("Данные изменены!"),document.location.reload()):(b.abort(),a(c.text))},"json")):a("Не указан адрес"):a("Не указано изделие")}});$("#product").productList(ZAYAV.product);zayavZamerDtime(ZAYAV)}),$(".dog_edit").click(function(){var a=_dialog({width:500,top:30,head:"Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label">Клиент:      <td>'+ZAYAV.client_fio+'<tr><td class="label top">Изделие:\t<td id="product"><tr><td class="label">Адрес установки:<td><INPUT type="text" id="adres" maxlength="100" value="'+
ZAYAV.adres+'" /></table>',butSubmit:"Сохранить",submit:function(){var b,c={op:"dog_edit",zayav_id:ZAYAV.id,product:$("#product").productList("get"),adres:$("#adres").val()};c.product?"count_error"==c.product?b="Некорректно введено количество изделий":c.adres?(a.process(),$.post(AJAX_MAIN,c,function(b){b.success?(a.close(),_msg("Данные изменены!"),document.location.reload()):a.abort()},"json")):b="Не указан адрес":b="Не указано изделие";b&&a.bottom.vkHint({msg:'<SPAN class="red">'+b+"</SPAN>",top:-47,
left:161,indent:40,show:1,remove:1})}});$("#product").productList(ZAYAV.product)}),$(".set_edit").click(function(){function a(){var a,d={op:"set_edit",zayav_id:ZAYAV.id,product:$("#product").productList("get"),adres:$("#adres").val(),nomer_vg:$("#nomer_vg").val(),nomer_g:$("#nomer_g").val(),nomer_d:$("#nomer_d").val()};d.product?"count_error"==d.product?a="Некорректно введено количество изделий":d.adres?(b.process(),$.post(AJAX_MAIN,d,function(a){a.success?(b.close(),_msg("Данные изменены!"),document.location.reload()):
b.abort()},"json")):a="Не указан адрес":a="Не указано изделие";a&&b.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-47,left:161,indent:40,show:1,remove:1})}var b=_dialog({width:500,top:30,head:"Установка №"+ZAYAV.id+" - Редактирование",content:'<table class="zayav-info-edit"><tr><td class="label">Клиент:      <td>'+ZAYAV.client_fio+'<tr><td class="label top">Изделие:\t<td id="product"><tr><td class="label">Адрес установки:<td><INPUT type="text" id="adres" maxlength="100" value="'+ZAYAV.adres+
'" /><tr><td class="label">Номер ВГ:\t   <td><INPUT type="text" id="nomer_vg" maxlength="30" value="'+ZAYAV.nomer_vg+'" /><tr><td class="label">Номер Ж: \t   <td><INPUT type="text" id="nomer_g" maxlength="30" value="'+ZAYAV.nomer_g+'" /><tr><td class="label">Номер Д: \t   <td><INPUT type="text" id="nomer_d" maxlength="30" value="'+ZAYAV.nomer_d+'" /></table>',butSubmit:"Сохранить",submit:a});$("#product").productList(ZAYAV.product);$("#adres,#nomer_vg,#nomer_g,#nomer_d").keyEnter(a)}),$(".acc-add").click(function(){function a(){var a,
d={op:"accrual_add",zayav_id:ZAYAV.id,sum:$("#sum").val(),prim:$("#prim").val()};REGEXP_NUMERIC.test(d.sum)?(b.process(),$.post(AJAX_MAIN,d,function(a){b.abort();a.success&&(b.close(),_msg("Начисление успешно произведено."),$("#income_spisok").html(a.html))},"json")):(a="Некорректно указана сумма.",$("#sum").focus());a&&b.bottom.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-48,left:123,indent:40,remove:1,show:1,correct:0})}var b=_dialog({top:60,width:420,head:"Начисление",content:'<TABLE class="accrual-add"><tr><td class="label">Сумма: <td><input type="text" id="sum" class="money" maxlength="6" /> руб.<tr><td class="label">Примечание:<em>(не обязательно)</em><td><input type="text" id="prim" maxlength="100" /></TABLE>',
submit:a});$("#sum").focus();$("#sum,#prim").keyEnter(a)}),$(".delete").click(function(){var a=_dialog({top:110,width:250,head:"Удаление заявки",content:"<CENTER>Подтвердите удаление заявки.</CENTER>",butSubmit:"Удалить",submit:function(){var b={op:"zayav_delete",zayav_id:ZAYAV.id};a.process();$.post(AJAX_MAIN,b,function(a){a.success&&(location.href=URL+"&p=client&d=info&id="+a.client_id)},"json")}})}),$(".rashod-edit").click(function(){var a=_dialog({width:470,top:30,head:"Изменение расходов заявки",
content:'<table class="zayav-rashod-edit"><tr><td class="label">Заявка: <td><b>'+ZAYAV.head+'</b><tr><td class="label topi">Расходы:<td id="zrs"></table>',butSubmit:"Сохранить",submit:function(){var b={op:"zayav_rashod_edit",zayav_id:ZAYAV.id,rashod:$("#zrs").zayavRashod("get")};"sum_error"==b.rashod?a.bottom.vkHint({msg:'<SPAN class="red">Некорректно указана сумма</SPAN>',top:-47,left:147,indent:40,show:1,remove:1}):(a.process(),$.post(AJAX_MAIN,b,function(b){b.success?($(".zrashod").html(b.html),
ZAYAV.rashod=b.array,a.close(),_msg("Сохранено.")):a.abort()},"json"))}});$("#zrs").zayavRashod(ZAYAV.rashod)}));0<$("#remind").length&&$(".goyear").click(function(){$("#remind").addClass("y")});0<$("#setup_rules").length&&($("#gtab_save").click(function(){function a(a){c.vkHint({msg:'<SPAN class="red">'+a+"</SPAN>",top:-57,left:-6,indent:40,show:1,remove:1})}var b={op:"setup_worker_save",viewer_id:RULES_VIEWER_ID,first_name:$("#first_name").val(),last_name:$("#last_name").val(),post:$("#post").val()},
c=$(this).parent();b.first_name?b.last_name?(c.addClass("busy"),$.post(AJAX_MAIN,b,function(a){c.removeClass("busy");a.success&&_msg("Сохранено.")},"json")):(a("Не указана фамилия"),$("#last_name").focus()):(a("Не указано имя"),$("#first_name").focus())}),$("#rules_appenter")._check(function(a,b){$(".app-div")[(0==a?"add":"remove")+"Class"]("dn");$(".setup-div").addClass("dn");setupRulesSet(a,b);$("#rules_setup")._check(0);$("#rules_worker")._check(0);$("#rules_product")._check(0);$("#rules_income")._check(0);
$("#rules_zayavrashod")._check(0);$("#rules_historyshow")._check(0)}),$("#rules_setup")._check(function(a,b){$(".setup-div")[(0==a?"add":"remove")+"Class"]("dn");setupRulesSet(a,b);$("#rules_worker")._check(0);$("#rules_product")._check(0);$("#rules_income")._check(0);$("#rules_zayavrashod")._check(0)}),$("#rules_worker")._check(setupRulesSet),$("#rules_rekvisit")._check(setupRulesSet),$("#rules_product")._check(setupRulesSet),$("#rules_income")._check(setupRulesSet),$("#rules_zayavrashod")._check(setupRulesSet),
$("#rules_historyshow")._check(setupRulesSet));0<$("#setup_rekvisit").length&&$(".vkButton").click(function(){var a=$(this),b={op:"setup_rekvisit",org_name:$("#org_name").val(),ogrn:$("#ogrn").val(),inn:$("#inn").val(),kpp:$("#kpp").val(),yur_adres:$("#yur_adres").val(),telefon:$("#telefon").val(),ofice_adres:$("#ofice_adres").val()};a.addClass("busy");$.post(AJAX_MAIN,b,function(b){a.removeClass("busy");b.success&&_msg("Информация сохранена.")},"json")})});
